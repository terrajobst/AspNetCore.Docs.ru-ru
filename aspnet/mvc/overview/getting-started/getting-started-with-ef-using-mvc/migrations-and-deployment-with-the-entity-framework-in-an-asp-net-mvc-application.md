---
uid: mvc/overview/getting-started/getting-started-with-ef-using-mvc/migrations-and-deployment-with-the-entity-framework-in-an-asp-net-mvc-application
title: Code First Migrations и развертывание с помощью Entity Framework в приложении ASP.NET MVC | Документация Майкрософт
author: tdykstra
description: Пример веб-приложение университета Contoso демонстрирует создание приложения ASP.NET MVC 5, используя Entity Framework 6 Code First и Visual Studio...
ms.author: aspnetcontent
manager: wpickett
ms.date: 11/07/2014
ms.topic: article
ms.assetid: d4dfc435-bda6-4621-9762-9ba270f8de4e
ms.technology: dotnet-mvc
msc.legacyurl: /mvc/overview/getting-started/getting-started-with-ef-using-mvc/migrations-and-deployment-with-the-entity-framework-in-an-asp-net-mvc-application
msc.type: authoredcontent
ms.openlocfilehash: 836711b05599087b540ad16bb5f462dd6baa287f
ms.sourcegitcommit: 953ff9ea4369f154d6fd0239599279ddd3280009
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/03/2018
ms.locfileid: "37400222"
---
<a name="code-first-migrations-and-deployment-with-the-entity-framework-in-an-aspnet-mvc-application"></a>Code First Migrations и развертывание с помощью Entity Framework в приложении ASP.NET MVC
====================
по [том Дайкстра](https://github.com/tdykstra)

[Скачать завершенный проект](http://code.msdn.microsoft.com/ASPNET-MVC-Application-b01a9fe8) или [скачать PDF](http://download.microsoft.com/download/0/F/B/0FBFAA46-2BFD-478F-8E56-7BF3C672DF9D/Getting%20Started%20with%20Entity%20Framework%206%20Code%20First%20using%20MVC%205.pdf)

> Пример веб-приложение университета Contoso демонстрирует создание приложения ASP.NET MVC 5, используя Entity Framework 6 Code First и Visual Studio 2013. Сведения о серии руководств см. в [первом руководстве серии](creating-an-entity-framework-data-model-for-an-asp-net-mvc-application.md).

Пока приложение будет выполняться локально в IIS Express на компьютере разработчика. В реальном приложении сделать доступным для других пользователей в Интернете, необходимо развернуть его на веб-поставщик услуг размещения. В этом руководстве вы развернете приложение университета Contoso в облако, в Azure.

Учебник содержит следующие разделы:

- Включение Code First Migrations. Функция миграций позволяет изменить модель данных и развертывания изменений в рабочей среде путем обновления схемы базы данных без необходимости удаления и повторного создания базы данных.
- Развертывание в Azure. Этот шаг является необязательным; оставшихся учебниках можно будет продолжить без развернут проект.

Мы рекомендуем использовать процесс непрерывной интеграции с системой управления версиями для развертывания, что этот учебник не охватывает разделы. Дополнительные сведения см. в разделе [система управления версиями](xref:aspnet/overview/developing-apps-with-windows-azure/building-real-world-cloud-apps-with-windows-azure/source-control) и [непрерывной интеграции](xref:aspnet/overview/developing-apps-with-windows-azure/building-real-world-cloud-apps-with-windows-azure/continuous-integration-and-continuous-delivery) главах [Создание реальных облачных приложений в Azure](xref:aspnet/overview/developing-apps-with-windows-azure/building-real-world-cloud-apps-with-windows-azure/introduction) электронная книга.

## <a name="enable-code-first-migrations"></a>Включение Code First Migrations

При разработке нового приложения ваша модель данных часто меняется, и при каждом таком изменении она нарушает синхронизацию с базой данных. Вы настроили платформе Entity Framework автоматически удалить и повторно создать базу данных каждый раз при изменении модели данных. При Добавление, удаление, или изменении классов сущностей или изменении вашей `DbContext` класса, при следующем запуске приложения оно автоматически удаляет существующую базу данных, создает новый, который соответствует модели и заполняет ее тестовыми данными.

Этот способ для обеспечения синхронизации базы данных с моделью данных хорошо работает до развертывания приложения в рабочей среде. Когда приложение выполняется в рабочей среде, оно обычно хранит данные, которые вы хотите сохранить, и вы не хотите потерять все, что каждый раз при внесении изменений, таких как добавление нового столбца. [Code First Migrations](https://msdn.microsoft.com/data/jj591621) функция решает эту проблему, включив Code First обновить схему базы данных вместо удаления и повторного создания базы данных. В этом руководстве вы развернете приложение, и для подготовки, вы будете разрешить миграции.

1. Отключить инициализатора, который мы настроили ранее, комментирования или удалив `contexts` элемент, добавленный в файл Web.config приложения.

    [!code-xml[Main](migrations-and-deployment-with-the-entity-framework-in-an-asp-net-mvc-application/samples/sample1.xml?highlight=2,6)]
2. Также в приложении *Web.config* файл, измените имя базы данных в строке подключения на ContosoUniversity2.

    [!code-xml[Main](migrations-and-deployment-with-the-entity-framework-in-an-asp-net-mvc-application/samples/sample2.xml?highlight=2)]

    Это изменение настраивает проект, чтобы первая миграция создала базу данных. Это не является обязательным, но вы увидите Далее почему это хорошая идея.
3. Из **средства** меню, щелкните **диспетчер пакетов библиотеки** и затем **консоль диспетчера пакетов**.

    ![Selecting_Package_Manager_Console](https://asp.net/media/4336350/1pm.png)
4. В `PM>` командной строке введите следующие команды:

    `enable-migrations`  
    `add-migration InitialCreate`

    ![команды Enable-migrations](migrations-and-deployment-with-the-entity-framework-in-an-asp-net-mvc-application/_static/image1.png)

    `enable-migrations` Команда создает *миграций* папки в проекте ContosoUniversity и он помещает в нее *Configuration.cs* файл, который можно изменять для настройки миграций.

    (Если вы пропустили на предыдущем шаге, который необходимо изменить имя базы данных, миграция будет найти существующую базу данных и автоматически выполнять `add-migration` команды. Это нормально, это просто значит, что не будет работать, чтобы проверить код миграции перед развертыванием базы данных. Более поздние версии, при запуске `update-database` команды, ничего не происходит, так как база данных уже будет существовать.)

    ![Папку migrations](migrations-and-deployment-with-the-entity-framework-in-an-asp-net-mvc-application/_static/image2.png)

    Как и класс инициализатора, который вы уже видели, `Configuration` класс включает `Seed` метод.

    [!code-csharp[Main](migrations-and-deployment-with-the-entity-framework-in-an-asp-net-mvc-application/samples/sample3.cs)]

    Цель [начальное значение](https://msdn.microsoft.com/library/hh829453(v=vs.103).aspx) метод — научить вас вставлять или обновлять данные теста после Code First создает или обновляет базу данных. Метод вызывается при создании базы данных, и каждый раз при обновлении схемы базы данных после изменения модели данных.

### <a name="set-up-the-seed-method"></a>Настройка метода заполнения

При удалении и повторное создание базы данных для каждого изменения модели данных, используется класс инициализатора `Seed` метод вставляемый проверочных данных, так как база данных уничтожается после каждого изменения модели и все тестовые данные теряются. С помощью Code First Migrations, тест, данные сохраняются после изменения базы данных, таким образом включая тестовых данных в [начальное значение](https://msdn.microsoft.com/library/hh829453(v=vs.103).aspx) метод обычно не требуется. На самом деле, вы не хотите `Seed` метод для вставки данных теста при использовании миграции для развертывания базы данных в рабочей среде, так как `Seed` метод будет выполняться в рабочей среде. В этом случае требуется `Seed` метод только данные, которые необходимо вставить в базу данных в рабочей среде. Например, может потребоваться базы данных, для включения названия фактическое отделов в `Department` таблицы, когда приложение становится доступным для рабочей среды.

В этом учебнике вы будете использовать миграции для развертывания, а `Seed` метод в любом случае Вставка тестовых данных для повышения его читаемости увидеть, как работает функциональных возможностей приложения без необходимости вручную вставить большие объемы данных.

1. Замените содержимое файла *Configuration.cs* файла следующий код, который загрузит тестовые данные в новую базу данных. 

    [!code-csharp[Main](migrations-and-deployment-with-the-entity-framework-in-an-asp-net-mvc-application/samples/sample4.cs)]

    [Начальное значение](https://msdn.microsoft.com/library/hh829453(v=vs.103).aspx) метод принимает объект контекста базы данных как входной параметр и код в метод использует этот объект для добавления новых сущностей в базу данных. Для каждого типа сущности, код создает коллекцию новых сущностей, добавляет их в соответствующий [DbSet](https://msdn.microsoft.com/library/system.data.entity.dbset(v=vs.103).aspx) свойства, а затем сохраняет изменения в базе данных. Нет необходимости вызывать [SaveChanges](https://msdn.microsoft.com/library/system.data.entity.dbcontext.savechanges(v=VS.103).aspx) метод после каждой группы сущностей, как показано здесь, но это поможет вам найти источник проблемы, если возникает исключение, когда код записывает в базу данных.

    Некоторые операторы, которые вставляют данные используют [AddOrUpdate](https://msdn.microsoft.com/library/system.data.entity.migrations.idbsetextensions.addorupdate(v=vs.103).aspx) метод для выполнения операции «вставки-обновления». Так как `Seed` метод выполняется при каждом выполнении `update-database` команды обычно после каждую операцию миграции, нельзя просто вставить данные, так как строки, вы пытаетесь добавить уже будут существует после первой миграции, который создает базу данных. Операция «вставки-обновления» позволяет избежать ошибок, произойдет при попытке вставить строку, которая уже существует, но он ***переопределяет*** любые изменения данных, внесенные во время тестирования приложения. Тестовыми данными в некоторых таблицах вы не хотите, чтобы происходить: в некоторых случаях при изменении данных во время тестирования необходимым вам изменениям после обновления базы данных. В этом случае необходимо выполнить операцию вставки условного: вставить строку, только в том случае, если он еще не существует. Метод заполнения использует оба подхода.

    Первый параметр, передаваемый [AddOrUpdate](https://msdn.microsoft.com/library/system.data.entity.migrations.idbsetextensions.addorupdate(v=vs.103).aspx) метод задает свойство, используемое для проверки, если строка уже существует. Для тестовых данных учащихся, вы предоставляете `LastName` свойство может использоваться для этой цели, так как каждой фамилии в списке является уникальным:

    [!code-csharp[Main](migrations-and-deployment-with-the-entity-framework-in-an-asp-net-mvc-application/samples/sample5.cs)]

    Предполагается, что последний имена являются уникальными. Если вручную добавить учащихся с повторяющимся именем последнего, вы получите следующее исключение при очередном выполнении миграции.

    Последовательность содержит более одного элемента

    Сведения о том, как обрабатывать избыточных данных, например с именем «Александр Carson» работы двух учащихся, см. в разделе [заполнения и отладка Entity Framework (EF) DBs](https://blogs.msdn.com/b/rickandy/archive/2013/02/12/seeding-and-debugging-entity-framework-ef-dbs.aspx) в блоге Рика Андерсона:. Дополнительные сведения о `AddOrUpdate` метод, см. в разделе [Будьте внимательны с помощью метода AddOrUpdate 4.3 EF](http://thedatafarm.com/blog/data-access/take-care-with-ef-4-3-addorupdate-method/) блога Джули Лерман.

    Код, создающий `Enrollment` сущностей предполагается, что у вас есть `ID` значение в сущностях в `students` коллекции, несмотря на то, что вы не задали это свойство в коде, который создает коллекции.

    [!code-csharp[Main](migrations-and-deployment-with-the-entity-framework-in-an-asp-net-mvc-application/samples/sample6.cs?highlight=2)]

    Можно использовать `ID` здесь свойство поскольку `ID` имеет значение при вызове `SaveChanges` для `students` коллекции. EF автоматически получает значение первичного ключа, если он вставляет сущность в базе данных, и обновляет `ID` свойство сущности в памяти.

    Код, который добавляет каждое из них `Enrollment` сущность `Enrollments` набор сущностей не использует `AddOrUpdate` метод. Он проверяет, если сущность уже существует и вставляет сущность, если он не существует. Такой подход позволяет сохранить изменения, внесенные в регистрации корпоративного класса с помощью пользовательского интерфейса приложения. Код просматривает каждый член `Enrollment` [списка](https://msdn.microsoft.com/library/6sh2ey19.aspx) и если регистрации не найден в базе данных, он добавляет регистрации к базе данных. Первый раз, обновить базу данных, базы данных будут пусты, поэтому он добавляет каждой регистрации.

    [!code-csharp[Main](migrations-and-deployment-with-the-entity-framework-in-an-asp-net-mvc-application/samples/sample7.cs)]
2. Выполните построение проекта.

### <a name="execute-the-first-migration"></a>Выполнение первой миграции

При выполнении `add-migration` команды миграции созданный код, который создаст базу данных с нуля. Этот код присутствует также в *миграций* папку, в файл с именем  *&lt;timestamp&gt;\_InitialCreate.cs*. `Up` Метод `InitialCreate` класс создает таблицы базы данных, которые соответствуют наборам сущностей модели данных, и `Down` метод удаляет их.

[!code-csharp[Main](migrations-and-deployment-with-the-entity-framework-in-an-asp-net-mvc-application/samples/sample8.cs)]

Функция миграций вызывает метод `Up`, чтобы реализовать изменения модели данных для миграции. При вводе команды для отката обновления функция миграций вызывает метод `Down`.

Это связано с первоначальной миграции, который был создан, когда вы ввели `add-migration InitialCreate` команды. Параметр (`InitialCreate` в примере) используется для файла имя и может быть любым; обычно выбрать слово или фразу, которая обобщает, что необходимо сделать после миграции. Например, можно назвать миграцию &quot;AddDepartmentTable&quot;.

Если вы создали первоначальную миграцию, когда база данных уже существовала, код для создания базы данных формируется, но выполнять его не требуется, так как база данных уже соответствует модели данных. Однако при развертывании приложения в другой среде, где база данных еще не существует, этот код будет выполняться для создания базы данных, поэтому рекомендуется сначала его протестировать. Вот почему ранее вы изменили имя базы данных в строке подключения — это позволяет функции миграций создать базу данных с нуля.

1. В **консоль диспетчера пакетов** окно, введите следующую команду:

    `update-database`

    ![](migrations-and-deployment-with-the-entity-framework-in-an-asp-net-mvc-application/_static/image3.png)

    `update-database` Выполняется команда `Up` метод для создания базы данных, а затем выполняется `Seed` метод для заполнения базы данных. Тот же процесс будет выполняться автоматически в рабочей среде после развертывания приложения, как можно будет увидеть в следующем разделе.
2. Используйте **обозревателя серверов** для проверки базы данных, как это делалось в первом руководстве и запустите приложение, чтобы убедиться, что все по-прежнему работает так же как и раньше.

## <a name="deploy-to-azure"></a>Развертывание в Azure

Пока приложение будет выполняться локально в IIS Express на компьютере разработчика. Чтобы сделать его доступным для других пользователей в Интернете, необходимо развернуть его на веб-поставщик услуг размещения. В этом разделе руководства вы развернете его в Azure. Этот раздел является необязательным; Вы можете пропустить этот шаг и продолжить к следующему учебнику, или можно изменить указания в этом разделе для другого поставщика услуг размещения по своему усмотрению.

### <a name="using-code-first-migrations-to-deploy-the-database"></a>С помощью Code First Migrations для развертывания базы данных

Развертывание базы данных будет использовать Code First Migrations. При создании профиля публикации, который можно использовать для настройки параметров для развертывания из Visual Studio, будет предложено выбрать флажок **обновления базы данных**. Этот параметр задан, то процесс развертывания, чтобы автоматически настроить приложение *Web.config* файл на конечном сервере, таким образом, Code First использовал `MigrateDatabaseToLatestVersion` инициализатор класса.

Visual Studio не выполняет никаких действий с базой данных во время развертывания, хотя он копирует проекта на целевой сервер. При запуске развернутого приложения, и он обращается к базе данных в первый раз после развертывания, Code First проверяет, если базы данных соответствует модели данных. Если существует несоответствие, Code First автоматически создает базу данных (если он еще не создан) или обновляет схему базы данных до последней версии (если база данных существует, но не соответствует модели). Если приложение реализует миграций `Seed` метод выполнения метода, после создания или обновления схемы.

Миграции `Seed` метод вставляет тестовых данных. При развертывании в рабочей среде, вы должны внести изменения `Seed` метод, чтобы он вставляет только те данные, которые должны быть вставлены в рабочую базу данных. Например в текущей модели данных может потребоваться иметь реальных курсы, но вымышленной учащихся в базе данных разработки. Можно написать `Seed` метод для загрузки в разработке и затем закомментируйте вымышленной учащихся, перед развертыванием в рабочей среде. Или можно написать `Seed` метод для загрузки только курсов и введите вымышленной учащихся в базе данных тестов вручную с помощью пользовательского интерфейса приложения.

### <a name="get-an-azure-account"></a>Получить учетную запись Azure

Вам потребуется учетная запись Azure. Если у вас еще нет, но у вас есть подписка Visual Studio, вы можете [активировать свои преимущества](https://azure.microsoft.com/pricing/member-offers/msdn-benefits-details/). В противном случае можно создать бесплатную пробную учетную запись всего за несколько минут. Дополнительные сведения см. в разделе [бесплатной пробной версии Azure](https://azure.microsoft.com/free/).

### <a name="create-a-web-site-and-a-sql-database-in-azure"></a>Создание веб-сайта и базы данных SQL в Azure

Веб-приложения в Azure будет выполняться в общей среде размещения, это означает, что он работает на виртуальных машинах (ВМ), которые являются общими с другими клиентами Azure. Общей среде размещения — это недорогой способ начать работу в облаке. Позже Если ваш веб-трафик увеличится, приложение можно масштабировать для удовлетворения потребностей, выполнив на выделенных виртуальных машинах. Чтобы узнать больше о ценах на параметры для службы приложений Azure, ознакомьтесь с документацией на [документация Azure](https://azure.microsoft.com/pricing/details/app-service/)

Используется для развертывания базы данных в базу данных SQL Azure. База данных SQL — это служба реляционной базы данных на основе облака, которая построена на технологиях SQL Server. Средства и приложения, работающие с SQL Server также работают с базой данных SQL.

1. В [портала управления Azure](https://portal.azure.com), нажмите кнопку **New** на левой вкладке щелкните **см. в разделе, все** в новой колонке и нажмите кнопку **веб-приложение и SQL** в **Web** раздел и, наконец **создать**.

    ![Кнопка "Создать" на портале управления](migrations-and-deployment-with-the-entity-framework-in-an-asp-net-mvc-application/_static/CreateWeb-Sql.png)

   **Новое веб-приложение и SQL - создание** откроется мастер.

2. В колонке введите строку в **имя_приложения** поле для использования в качестве уникального URL-адреса для вашего приложения. Полный URL-адрес будет состоять из введенной здесь плюс домена службы приложений по умолчанию (. azurewebsites.net). Если **имя_приложения** уже занято, мастер будет уведомлять об этом с красным значком *имя приложения Недоступно* сообщения. Если **имя_приложения** — доступны, отобразится зеленая галочка.

    ![Создание со ссылкой на базу данных на портале управления](migrations-and-deployment-with-the-entity-framework-in-an-asp-net-mvc-application/_static/Create-WebApp.png)

3. В **подписки** раскрывающемся списке выберите подписку Azure, в котором нужно **службы приложений** находиться.

4. В **группы ресурсов** текстовое поле, выберите группу ресурсов или создайте новую. Этот параметр указывает, какой веб-сайт будет выполняться в центр обработки данных. Дополнительные сведения о группах ресурсов, ознакомьтесь с документацией на [документация Azure](https://docs.microsoft.com/azure/azure-resource-manager/resource-group-overview#resource-groups).
5. Создайте новый **план службы приложений** , щелкнув *разделе службы приложений*, **Create New**и заполните **план службы приложений** (может быть совпадает с именем Служба приложений), **расположение**, и **Ценовая** (есть бесплатный вариант).

    ![](migrations-and-deployment-with-the-entity-framework-in-an-asp-net-mvc-application/_static/Create-AppService.png)
6. Нажмите кнопку **базы данных SQL**и выберите *Create New* или выберите существующую базу данных

    ![](migrations-and-deployment-with-the-entity-framework-in-an-asp-net-mvc-application/_static/Create-Database.png)

7. В **имя** введите имя для базы данных.
8. Нажмите кнопку **целевой сервер** выберите **Создание нового сервера**. Кроме того Если ранее вы создали сервер, можно выбрать этот сервер из списка доступных серверов.
9. Выберите **Ценовая** выберите *бесплатный*. Если требуются дополнительные ресурсы, базы данных можно масштабировать в любое время. Чтобы узнать больше о ценах на SQL Azure, ознакомьтесь с документацией на [документация Azure](https://azure.microsoft.com/pricing/details/sql-database/).
10. Изменить [параметры сортировки](https://docs.microsoft.com/sql/relational-databases/collations/collation-and-unicode-support) при необходимости.
11. Введите администратора **имя пользователя администратора SQL** и **пароль администратора SQL**. Если вы выбрали **новую базу данных SQL server**, не используйте имеющиеся имя и пароль, введите новое имя и пароль, который вы определяете теперь для последующего использования при доступе к базе данных. Если вы выбрали сервера, который вы создали ранее, вы введете учетные данные для этого сервера.
12. Сбор данных телеметрии можно включить для службы приложений с помощью Application Insights. Application Insights с немного времени собирает полезные события, исключения, зависимости, запрос и сведения о трассировке. Дополнительные сведения об Application Insights, приступить к работе [документация Azure](https://azure.microsoft.com/services/application-insights/).
13. Нажмите кнопку **создать** в нижней части колонки, чтобы указать, что Вы завершили.
  
    Портал управления возвращает на страницу панели мониторинга и **уведомления** колонке в верхней части страницы показывает, что создается сайт. Через некоторое время (обычно это занимает меньше минуты) будет существовать уведомление об успешном выполнении развертывания. На панели навигации в левой части нового **службы приложений** отображается в *службы приложений* раздел и новый **базы данных SQL** отображается в *баз данных SQL*  раздел.

### <a name="deploy-the-application-to-azure"></a>Развертывание приложения в Azure

1. В Visual Studio щелкните правой кнопкой мыши проект в **обозревателе решений** и выберите **публикации** в контекстном меню.
  
    ![Публикация в контекстном меню проекта](migrations-and-deployment-with-the-entity-framework-in-an-asp-net-mvc-application/_static/image10.png)
2. В **профиль** вкладке **веб-публикации** мастера, нажмите кнопку **служба приложений Microsoft Azure**.
  
    ![Импорт параметров публикации](migrations-and-deployment-with-the-entity-framework-in-an-asp-net-mvc-application/_static/Publish-ChooseTarget.png)
3. Если вы не добавили ранее подписки Azure в Visual Studio, выполните действия на экране. Эти действия позволяют Visual Studio для подключения к подписке Azure таким образом, список **службы приложений** будет включать веб-сайт.
 
4. Выберите **подписки** вы добавили службы приложений, затем **план службы приложений** папку службы приложений является частью, и, наконец **службы приложений** сам следуют **ОК**.

    ![Выберите службу приложений](migrations-and-deployment-with-the-entity-framework-in-an-asp-net-mvc-application/_static/Publish-AppService.png)
5. После настройки профиля **подключения** отображается вкладка. Нажмите кнопку **проверить подключение** чтобы убедиться в том, что параметры заданы правильно

    ![Проверка подключения](migrations-and-deployment-with-the-entity-framework-in-an-asp-net-mvc-application/_static/Publish-Connection.png)
6. После проверки подключения зеленая галочка отображается рядом с полем **проверить подключение** кнопки. Нажмите кнопку **Далее**.
  
    ![Успешно проверенные подключения](migrations-and-deployment-with-the-entity-framework-in-an-asp-net-mvc-application/_static/Publish-SettingsValidated.png)
7. Откройте **строку подключения к удаленному** стрелку раскрывающегося списка в разделе **SchoolContext** и выберите строку подключения для базы данных, вы создали.
8. Выберите **обновления базы данных**.

    ![Вкладка "Параметры"](migrations-and-deployment-with-the-entity-framework-in-an-asp-net-mvc-application/_static/Publish-Settings.png)

    Этот параметр задан, то процесс развертывания, чтобы автоматически настроить приложение *Web.config* файл на конечном сервере, таким образом, Code First использовал `MigrateDatabaseToLatestVersion` инициализатор класса.
9. Нажмите кнопку **Далее**.
10. В **предварительной версии** щелкните **начать просмотр**.
  
    ![Кнопка StartPreview вкладке предварительного просмотра](migrations-and-deployment-with-the-entity-framework-in-an-asp-net-mvc-application/_static/Publish-Preview.png)
  
    На вкладке отображается список файлов, которые будут скопированы на сервер. В процессе предварительного просмотра не требуется, чтобы опубликовать приложение, но является полезные функции, которые следует учитывать. В этом случае не нужно ничего делать со списком файлов, который отображается. При развертывании этого приложения в этом списке будет только файлы, которые были изменены.
    ![Выходной файл StartPreview](migrations-and-deployment-with-the-entity-framework-in-an-asp-net-mvc-application/_static/Publish-PreviewLoaded.png)

11. Нажмите кнопку **Опубликовать**.
    Visual Studio начнет процесс копирования файлов на сервере Azure.
12. **Вывода** окно показывает, какие действия по развертыванию были выполнены и передает об успешном завершении развертывания.
  
    ![Окно вывода, отчетом об успешном развертывании](migrations-and-deployment-with-the-entity-framework-in-an-asp-net-mvc-application/_static/Publish-BuildOutput.png)
13. После успешного развертывания в браузере по умолчанию автоматически откроется на URL-адрес развернутого веб-сайта.
    Созданное приложение теперь работает в облаке. 
  
    ![Students_index_page_with_paging](migrations-and-deployment-with-the-entity-framework-in-an-asp-net-mvc-application/_static/Publish-Site.png)

На этом этапе ваш *SchoolContext* базы данных в базе данных SQL Azure создан, так как вы выбрали **выполнить Code First Migrations (при запуске приложения)**. *Web.config* файл развернутого веб-узла был изменен, чтобы [MigrateDatabaseToLatestVersion](https://msdn.microsoft.com/library/hh829476(v=vs.103).aspx) инициализатор запускается в первый раз, код считывает или записывает данные в базе данных (что произошло При выборе **учащихся** вкладки):

![](https://asp.net/media/4367421/mig.png)

Процесс развертывания также создается новая строка подключения *(SchoolContext\_DatabasePublish*) для Code First Migrations для обновления схемы базы данных и заполнения базы данных.

![Строка подключения Database_Publish](migrations-and-deployment-with-the-entity-framework-in-an-asp-net-mvc-application/_static/image26.png)

Вы найдете развернутой версии файла Web.config на локальном компьютере в *ContosoUniversity\obj\Release\Package\PackageTmp\Web.config*. Доступ к развернутому *Web.config* сам файл с помощью FTP. Инструкции см. в разделе [веб-развертывание ASP.NET с помощью Visual Studio: развертывание обновления кода](xref:web-forms/overview/deployment/visual-studio-web-deployment/deploying-a-code-update). Следуйте инструкциям, которые начинаются с «Чтобы использовать средство FTP, необходимы три вещи: URL-адрес FTP, имя пользователя и пароль.»

> [!NOTE]
> Веб-приложение не реализует безопасности, поэтому любой кто найдет этот URL-адрес можно изменить данные. Инструкции о том, как защитить веб-сайт, см. в разделе [развертывание безопасного приложения ASP.NET MVC с членством, OAuth и базой данных SQL в Azure](https://docs.microsoft.com/aspnet/core/security/authorization/secure-data). Можно запретить другим пользователям с помощью сайта с помощью портала управления Azure или **обозревателя серверов** в Visual Studio, чтобы остановить сайт.


![](migrations-and-deployment-with-the-entity-framework-in-an-asp-net-mvc-application/_static/Stop-Service.png)

## <a name="advanced-migrations-scenarios"></a>Сценарии дополнительные миграции

Если развернуть базу данных, выполнив миграции автоматически, как показано в этом руководстве развертывается на веб-сайт, который выполняется на нескольких серверах, можно получить несколько серверов, попытки запуска миграции, в то же время. Миграция являются атомарными, поэтому если же миграцию следует выполнять два сервера, один будет успешно, а другой не удастся (предполагается, что все действия нельзя выполнить дважды). Если вы хотите избежать этих проблем в этом сценарии можно вызывать миграции вручную и настроить собственный код, чтобы это происходит только один раз. Дополнительные сведения см. в разделе [запущена и сценариев миграции из кода](http://romiller.com/2012/02/09/running-scripting-migrations-from-code/) в блоге Роуэн Миллер и [Migrate.exe](https://msdn.microsoft.com/data/jj618307) (для выполнения миграции из командной строки) на сайте MSDN.

Сведения о других сценариях миграции, см. в разделе [миграций серию](https://blogs.msdn.com/b/adonet/archive/2014/03/12/migrations-screencast-series.aspx).

## <a name="code-first-initializers"></a>Инициализаторы первого кода

В разделе развертывания вы видели [MigrateDatabaseToLatestVersion](https://msdn.microsoft.com/library/hh829476(v=vs.103).aspx) используется инициализатор. Код сначала также предоставляет другие инициализаторы, включая [CreateDatabaseIfNotExists](https://msdn.microsoft.com/library/gg679221(v=vs.103).aspx) (по умолчанию), [DropCreateDatabaseIfModelChanges](https://msdn.microsoft.com/library/gg679604(v=VS.103).aspx) (который вы использовали ранее) и [ DropCreateDatabaseAlways](https://msdn.microsoft.com/library/gg679506(v=VS.103).aspx). `DropCreateAlways` Инициализаторов может быть полезна для настройки условий для модульных тестов. Можно также написать собственные инициализаторы и инициализатор можно вызвать явным образом, если вы не хотите подождать, пока приложение для считывания и записи в базу данных. Во время этот учебник написан в ноябре 2013 г. можно использовать только инициализаторы Create и DropCreate перед включением миграций. Над тем, чтобы эти инициализаторы может использоваться с миграциями также работает команда Entity Framework.

Дополнительные сведения об инициализаторах см. в разделе [инициализаторы основные сведения о базе данных в Entity Framework Code First](http://www.codeguru.com/csharp/article.php/c19999/Understanding-Database-Initializers-in-Entity-Framework-Code-First.htm) и главе 6 книги [Programming Entity Framework: Code First](http://shop.oreilly.com/product/0636920022220.do) с Джули Лерман и Роуэн Миллер.

## <a name="summary"></a>Сводка

В этом руководстве вы узнали, как включение migrations и развертывание приложения. В следующем учебном курсе вы начнете рассматривать более сложными аспектами, развернув модель данных.

Оставьте свои отзывы на том, как вам понравилось, и этот учебник, и что можно улучшить. Можно также запросить новые темы на [показать мне как с помощью кода](http://aspnet.uservoice.com/forums/228522-show-me-how-with-code).

Ссылки на другие ресурсы Entity Framework можно найти в [доступ к данным ASP.NET — рекомендуемые ресурсы](xref:whitepapers/aspnet-data-access-content-map).

> [!div class="step-by-step"]
> [Назад](xref:mvc/overview/getting-started/getting-started-with-ef-using-mvc/connection-resiliency-and-command-interception-with-the-entity-framework-in-an-asp-net-mvc-application)
> [Вперед](xref:mvc/overview/getting-started/getting-started-with-ef-using-mvc/creating-a-more-complex-data-model-for-an-asp-net-mvc-application)
