---
title: Управление ключами в ASP.NET Core
author: rick-anderson
description: Сведения о реализации интерфейсов API управления ключами ASP.NET Core Data Protection.
ms.author: riande
ms.date: 10/14/2016
uid: security/data-protection/implementation/key-management
ms.openlocfilehash: c571222d734fa69183563aefa5cc6ce5a10e7612
ms.sourcegitcommit: 9a129f5f3e31cc449742b164d5004894bfca90aa
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/06/2020
ms.locfileid: "78653992"
---
# <a name="key-management-in-aspnet-core"></a><span data-ttu-id="b8945-103">Управление ключами в ASP.NET Core</span><span class="sxs-lookup"><span data-stu-id="b8945-103">Key management in ASP.NET Core</span></span>

<a name="data-protection-implementation-key-management"></a>

<span data-ttu-id="b8945-104">Система защиты данных автоматически управляет временем существования главных ключей, используемых для защиты и снятия защиты полезных данных.</span><span class="sxs-lookup"><span data-stu-id="b8945-104">The data protection system automatically manages the lifetime of master keys used to protect and unprotect payloads.</span></span> <span data-ttu-id="b8945-105">Каждый ключ может находиться в одном из четырех этапов:</span><span class="sxs-lookup"><span data-stu-id="b8945-105">Each key can exist in one of four stages:</span></span>

* <span data-ttu-id="b8945-106">Создан — ключ существует в кольце, но еще не активирован.</span><span class="sxs-lookup"><span data-stu-id="b8945-106">Created - the key exists in the key ring but has not yet been activated.</span></span> <span data-ttu-id="b8945-107">Ключ не должен использоваться для новых операций защиты, пока не истечет достаточно времени, пока у ключа есть шанс распространить на все компьютеры, использующие этот звонок.</span><span class="sxs-lookup"><span data-stu-id="b8945-107">The key shouldn't be used for new Protect operations until sufficient time has elapsed that the key has had a chance to propagate to all machines that are consuming this key ring.</span></span>

* <span data-ttu-id="b8945-108">Активный — ключ существует в кольце ключа и должен использоваться для всех новых операций защиты.</span><span class="sxs-lookup"><span data-stu-id="b8945-108">Active - the key exists in the key ring and should be used for all new Protect operations.</span></span>

* <span data-ttu-id="b8945-109">Срок действия истек. ключ запускал свое естественное время существования и больше не должен использоваться для новых операций защиты.</span><span class="sxs-lookup"><span data-stu-id="b8945-109">Expired - the key has run its natural lifetime and should no longer be used for new Protect operations.</span></span>

* <span data-ttu-id="b8945-110">Отозвано — ключ скомпрометирован и не должен использоваться для новых операций защиты.</span><span class="sxs-lookup"><span data-stu-id="b8945-110">Revoked - the key is compromised and must not be used for new Protect operations.</span></span>

<span data-ttu-id="b8945-111">Созданные, активные и просроченные ключи могут использоваться для снятия защиты входящих полезных данных.</span><span class="sxs-lookup"><span data-stu-id="b8945-111">Created, active, and expired keys may all be used to unprotect incoming payloads.</span></span> <span data-ttu-id="b8945-112">Отмененные ключи по умолчанию нельзя использовать для снятия защиты полезных данных, но разработчик приложения может [переопределить это поведение](xref:security/data-protection/consumer-apis/dangerous-unprotect#data-protection-consumer-apis-dangerous-unprotect) при необходимости.</span><span class="sxs-lookup"><span data-stu-id="b8945-112">Revoked keys by default may not be used to unprotect payloads, but the application developer can [override this behavior](xref:security/data-protection/consumer-apis/dangerous-unprotect#data-protection-consumer-apis-dangerous-unprotect) if necessary.</span></span>

>[!WARNING]
> <span data-ttu-id="b8945-113">Разработчик может удалить ключ из круга ключей (например, удалив соответствующий файл из файловой системы).</span><span class="sxs-lookup"><span data-stu-id="b8945-113">The developer might be tempted to delete a key from the key ring (e.g., by deleting the corresponding file from the file system).</span></span> <span data-ttu-id="b8945-114">На этом этапе все данные, защищенные ключом, не будут расшифрованы, и аварийное переопределение, как и у отмененных ключей, отсутствует.</span><span class="sxs-lookup"><span data-stu-id="b8945-114">At that point, all data protected by the key is permanently undecipherable, and there's no emergency override like there's with revoked keys.</span></span> <span data-ttu-id="b8945-115">Удаление ключа — это действительно разрушительное поведение, поэтому система защиты данных не предоставляет API первого класса для выполнения этой операции.</span><span class="sxs-lookup"><span data-stu-id="b8945-115">Deleting a key is truly destructive behavior, and consequently the data protection system exposes no first-class API for performing this operation.</span></span>

## <a name="default-key-selection"></a><span data-ttu-id="b8945-116">Выбор ключа по умолчанию</span><span class="sxs-lookup"><span data-stu-id="b8945-116">Default key selection</span></span>

<span data-ttu-id="b8945-117">Когда система защиты данных считывает ключ кольца из резервного репозитория, она попытается выполнить обнаружение ключа "по умолчанию" из кольца ключа.</span><span class="sxs-lookup"><span data-stu-id="b8945-117">When the data protection system reads the key ring from the backing repository, it will attempt to locate a "default" key from the key ring.</span></span> <span data-ttu-id="b8945-118">Ключ по умолчанию используется для новых операций защиты.</span><span class="sxs-lookup"><span data-stu-id="b8945-118">The default key is used for new Protect operations.</span></span>

<span data-ttu-id="b8945-119">Общий эвристический подход заключается в том, что система защиты данных выбирает ключ с самой последней датой активации в качестве ключа по умолчанию.</span><span class="sxs-lookup"><span data-stu-id="b8945-119">The general heuristic is that the data protection system chooses the key with the most recent activation date as the default key.</span></span> <span data-ttu-id="b8945-120">(Существует небольшой параметр фактор, позволяющий отклонять часы "сервер-сервер".) Если срок действия ключа истек или он отозван, и если приложение не отключило автоматическое создание ключей, будет создан новый ключ с немедленной активацией в соответствии с [истечением срока действия ключа и политикой отката](xref:security/data-protection/implementation/key-management#data-protection-implementation-key-management-expiration) .</span><span class="sxs-lookup"><span data-stu-id="b8945-120">(There's a small fudge factor to allow for server-to-server clock skew.) If the key is expired or revoked, and if the application has not disabled automatic key generation, then a new key will be generated with immediate activation per the [key expiration and rolling](xref:security/data-protection/implementation/key-management#data-protection-implementation-key-management-expiration) policy below.</span></span>

<span data-ttu-id="b8945-121">Причина, по которой система защиты данных создает новый ключ немедленно, вместо возврата к другому ключу заключается в том, что новое создание ключа должно рассматриваться как неявное истечение срока действия всех ключей, активированных до нового ключа.</span><span class="sxs-lookup"><span data-stu-id="b8945-121">The reason the data protection system generates a new key immediately rather than falling back to a different key is that new key generation should be treated as an implicit expiration of all keys that were activated prior to the new key.</span></span> <span data-ttu-id="b8945-122">Общая идея состоит в том, что новые ключи могут быть настроены с использованием разных алгоритмов или механизмов шифрования неактивных ключей, чем старые ключи, и система должна предпочесть текущую конфигурацию для возврата.</span><span class="sxs-lookup"><span data-stu-id="b8945-122">The general idea is that new keys may have been configured with different algorithms or encryption-at-rest mechanisms than old keys, and the system should prefer the current configuration over falling back.</span></span>

<span data-ttu-id="b8945-123">Существует исключение.</span><span class="sxs-lookup"><span data-stu-id="b8945-123">There's an exception.</span></span> <span data-ttu-id="b8945-124">Если разработчик приложения [отключил автоматическое создание ключей](xref:security/data-protection/configuration/overview#disableautomatickeygeneration), система защиты данных должна выбрать что-то в качестве ключа по умолчанию.</span><span class="sxs-lookup"><span data-stu-id="b8945-124">If the application developer has [disabled automatic key generation](xref:security/data-protection/configuration/overview#disableautomatickeygeneration), then the data protection system must choose something as the default key.</span></span> <span data-ttu-id="b8945-125">В этом сценарии система выберет неотозванный ключ с самой последней датой активации и имеет предпочтение, предоставленное ключам, которые имели время для распространения на другие компьютеры в кластере.</span><span class="sxs-lookup"><span data-stu-id="b8945-125">In this fallback scenario, the system will choose the non-revoked key with the most recent activation date, with preference given to keys that have had time to propagate to other machines in the cluster.</span></span> <span data-ttu-id="b8945-126">В качестве результата резервной системы может быть выбран ключ по умолчанию с истекшим сроком действия.</span><span class="sxs-lookup"><span data-stu-id="b8945-126">The fallback system may end up choosing an expired default key as a result.</span></span> <span data-ttu-id="b8945-127">Резервная система никогда не будет выбирать отозванный ключ в качестве ключа по умолчанию, и если ключ звонка пуст или каждый ключ был отозван, система выдаст ошибку при инициализации.</span><span class="sxs-lookup"><span data-stu-id="b8945-127">The fallback system will never choose a revoked key as the default key, and if the key ring is empty or every key has been revoked then the system will produce an error upon initialization.</span></span>

<a name="data-protection-implementation-key-management-expiration"></a>

## <a name="key-expiration-and-rolling"></a><span data-ttu-id="b8945-128">Срок действия ключа и его откат</span><span class="sxs-lookup"><span data-stu-id="b8945-128">Key expiration and rolling</span></span>

<span data-ttu-id="b8945-129">При создании ключа автоматически назначается дата активации {Now + 2 дня} и Дата окончания срока действия {Now + 90 дн.}.</span><span class="sxs-lookup"><span data-stu-id="b8945-129">When a key is created, it's automatically given an activation date of { now + 2 days } and an expiration date of { now + 90 days }.</span></span> <span data-ttu-id="b8945-130">2-дневная задержка перед активацией дает ключевое время для распространения по системе.</span><span class="sxs-lookup"><span data-stu-id="b8945-130">The 2-day delay before activation gives the key time to propagate through the system.</span></span> <span data-ttu-id="b8945-131">Это значит, что другие приложения, указывающие на резервное хранилище, смогут наблюдать за ключом в следующем периоде автоматического обновления, таким образом уменьшая вероятность того, что при активации ключевого звонка он распространяется на все приложения, которым может потребоваться его использовать.</span><span class="sxs-lookup"><span data-stu-id="b8945-131">That is, it allows other applications pointing at the backing store to observe the key at their next auto-refresh period, thus maximizing the chances that when the key ring does become active it has propagated to all applications that might need to use it.</span></span>

<span data-ttu-id="b8945-132">Если срок действия ключа по умолчанию истекает в течение двух дней, и если у этого звонка еще нет ключа, который будет активным после истечения срока действия ключа по умолчанию, система защиты данных автоматически сохранит новый ключ в кольце ключа.</span><span class="sxs-lookup"><span data-stu-id="b8945-132">If the default key will expire within 2 days and if the key ring doesn't already have a key that will be active upon expiration of the default key, then the data protection system will automatically persist a new key to the key ring.</span></span> <span data-ttu-id="b8945-133">Этот новый ключ имеет дату активации {срок действия ключа по умолчанию} и дату окончания срока действия {Now + 90 дн.}.</span><span class="sxs-lookup"><span data-stu-id="b8945-133">This new key has an activation date of { default key's expiration date } and an expiration date of { now + 90 days }.</span></span> <span data-ttu-id="b8945-134">Это позволяет системе автоматически выполнять откат ключей на регулярной основе без прерывания обслуживания.</span><span class="sxs-lookup"><span data-stu-id="b8945-134">This allows the system to automatically roll keys on a regular basis with no interruption of service.</span></span>

<span data-ttu-id="b8945-135">Могут возникнуть обстоятельства, при которых ключ будет создан с немедленной активацией.</span><span class="sxs-lookup"><span data-stu-id="b8945-135">There might be circumstances where a key will be created with immediate activation.</span></span> <span data-ttu-id="b8945-136">Одним из примеров может быть то, что приложение не выполнялось в течение времени, и срок действия всех ключей в кольце истек.</span><span class="sxs-lookup"><span data-stu-id="b8945-136">One example would be when the application hasn't run for a time and all keys in the key ring are expired.</span></span> <span data-ttu-id="b8945-137">В этом случае ключу присваивается Дата активации {Now} без обычной задержки активации в 2 дня.</span><span class="sxs-lookup"><span data-stu-id="b8945-137">When this happens, the key is given an activation date of { now } without the normal 2-day activation delay.</span></span>

<span data-ttu-id="b8945-138">Время жизни ключа по умолчанию составляет 90 дней, хотя это можно настроить, как показано в следующем примере.</span><span class="sxs-lookup"><span data-stu-id="b8945-138">The default key lifetime is 90 days, though this is configurable as in the following example.</span></span>

```csharp
services.AddDataProtection()
       // use 14-day lifetime instead of 90-day lifetime
       .SetDefaultKeyLifetime(TimeSpan.FromDays(14));
```

<span data-ttu-id="b8945-139">Администратор также может изменить масштаб всей системы по умолчанию, хотя явный вызов `SetDefaultKeyLifetime` переопределит любую системную политику.</span><span class="sxs-lookup"><span data-stu-id="b8945-139">An administrator can also change the default system-wide, though an explicit call to `SetDefaultKeyLifetime` will override any system-wide policy.</span></span> <span data-ttu-id="b8945-140">Время жизни ключа по умолчанию не может быть короче 7 дней.</span><span class="sxs-lookup"><span data-stu-id="b8945-140">The default key lifetime cannot be shorter than 7 days.</span></span>

## <a name="automatic-key-ring-refresh"></a><span data-ttu-id="b8945-141">Автоматическое обновление Key Ring</span><span class="sxs-lookup"><span data-stu-id="b8945-141">Automatic key ring refresh</span></span>

<span data-ttu-id="b8945-142">При инициализации системы защиты данных она считывает ключевое кольцо из базового репозитория и кэширует его в памяти.</span><span class="sxs-lookup"><span data-stu-id="b8945-142">When the data protection system initializes, it reads the key ring from the underlying repository and caches it in memory.</span></span> <span data-ttu-id="b8945-143">Этот кэш позволяет выполнять операции защиты и снятия защиты без обращения к резервному хранилищу.</span><span class="sxs-lookup"><span data-stu-id="b8945-143">This cache allows Protect and Unprotect operations to proceed without hitting the backing store.</span></span> <span data-ttu-id="b8945-144">Система автоматически проверит резервное хранилище на наличие изменений приблизительно каждые 24 часа или по истечении срока действия текущего ключа по умолчанию, в зависимости от того, что происходит раньше.</span><span class="sxs-lookup"><span data-stu-id="b8945-144">The system will automatically check the backing store for changes approximately every 24 hours or when the current default key expires, whichever comes first.</span></span>

>[!WARNING]
> <span data-ttu-id="b8945-145">Разработчики должны очень редко (если всегда) использовать API управления ключами напрямую.</span><span class="sxs-lookup"><span data-stu-id="b8945-145">Developers should very rarely (if ever) need to use the key management APIs directly.</span></span> <span data-ttu-id="b8945-146">Система защиты данных будет выполнять автоматическое управление ключами, как описано выше.</span><span class="sxs-lookup"><span data-stu-id="b8945-146">The data protection system will perform automatic key management as described above.</span></span>

<span data-ttu-id="b8945-147">Система защиты данных предоставляет интерфейс `IKeyManager`, который можно использовать для проверки и внесения изменений в кольцо ключа.</span><span class="sxs-lookup"><span data-stu-id="b8945-147">The data protection system exposes an interface `IKeyManager` that can be used to inspect and make changes to the key ring.</span></span> <span data-ttu-id="b8945-148">Система DI, предоставляющая экземпляр `IDataProtectionProvider`, может также предоставить экземпляр `IKeyManager` для вашего использования.</span><span class="sxs-lookup"><span data-stu-id="b8945-148">The DI system that provided the instance of `IDataProtectionProvider` can also provide an instance of `IKeyManager` for your consumption.</span></span> <span data-ttu-id="b8945-149">Кроме того, можно извлечь `IKeyManager` прямо из `IServiceProvider`, как показано в примере ниже.</span><span class="sxs-lookup"><span data-stu-id="b8945-149">Alternatively, you can pull the `IKeyManager` straight from the `IServiceProvider` as in the example below.</span></span>

<span data-ttu-id="b8945-150">Любая операция, которая изменяет кольцо ключа (создание нового ключа явным образом или выполнение отзыва), сделает кэш в памяти недействительным.</span><span class="sxs-lookup"><span data-stu-id="b8945-150">Any operation which modifies the key ring (creating a new key explicitly or performing a revocation) will invalidate the in-memory cache.</span></span> <span data-ttu-id="b8945-151">Следующий вызов `Protect` или `Unprotect` приведет к тому, что система защиты данных прочитает ключ звонка и воссоздаст кэш.</span><span class="sxs-lookup"><span data-stu-id="b8945-151">The next call to `Protect` or `Unprotect` will cause the data protection system to reread the key ring and recreate the cache.</span></span>

<span data-ttu-id="b8945-152">В приведенном ниже примере демонстрируется использование интерфейса `IKeyManager` для проверки и управления кольцом, включая отзыв существующих ключей и создание нового ключа вручную.</span><span class="sxs-lookup"><span data-stu-id="b8945-152">The sample below demonstrates using the `IKeyManager` interface to inspect and manipulate the key ring, including revoking existing keys and generating a new key manually.</span></span>

[!code-csharp[](key-management/samples/key-management.cs)]

[!INCLUDE[about the series](~/includes/code-comments-loc.md)]

## <a name="key-storage"></a><span data-ttu-id="b8945-153">Хранилище ключей</span><span class="sxs-lookup"><span data-stu-id="b8945-153">Key storage</span></span>

<span data-ttu-id="b8945-154">Система защиты данных имеет эвристический подход, позволяющий автоматически вычислить подходящее место хранения ключа и механизм шифрования неактивных ключей.</span><span class="sxs-lookup"><span data-stu-id="b8945-154">The data protection system has a heuristic whereby it attempts to deduce an appropriate key storage location and encryption-at-rest mechanism automatically.</span></span> <span data-ttu-id="b8945-155">Механизм сохраняемости ключей также настраивается разработчиком приложения.</span><span class="sxs-lookup"><span data-stu-id="b8945-155">The key persistence mechanism is also configurable by the app developer.</span></span> <span data-ttu-id="b8945-156">В следующих документах рассматриваются встроенные реализации этих механизмов.</span><span class="sxs-lookup"><span data-stu-id="b8945-156">The following documents discuss the in-box implementations of these mechanisms:</span></span>

* <xref:security/data-protection/implementation/key-storage-providers>
* <xref:security/data-protection/implementation/key-encryption-at-rest>
