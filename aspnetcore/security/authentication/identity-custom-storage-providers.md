---
title: Пользовательские поставщики хранилища для удостоверения ASP.NET Core
author: ardalis
description: Узнайте, как настроить пользовательские поставщики хранилища для удостоверения ASP.NET Core.
ms.author: riande
ms.custom: mvc
ms.date: 07/23/2019
uid: security/authentication/identity-custom-storage-providers
ms.openlocfilehash: da5293462451447766f7b3b5ff733e1ea9449f18
ms.sourcegitcommit: f30b18442ed12831c7e86b0db249183ccd749f59
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/23/2019
ms.locfileid: "68412514"
---
# <a name="custom-storage-providers-for-aspnet-core-identity"></a><span data-ttu-id="a0b51-103">Пользовательские поставщики хранилища для удостоверения ASP.NET Core</span><span class="sxs-lookup"><span data-stu-id="a0b51-103">Custom storage providers for ASP.NET Core Identity</span></span>

<span data-ttu-id="a0b51-104">Автор: [Стив Смит](https://ardalis.com/) (Steve Smith)</span><span class="sxs-lookup"><span data-stu-id="a0b51-104">By [Steve Smith](https://ardalis.com/)</span></span>

<span data-ttu-id="a0b51-105">ASP.NET Core Identity — это расширяемая система, которая позволяет создать пользовательский поставщик хранилища и подключить его к приложению.</span><span class="sxs-lookup"><span data-stu-id="a0b51-105">ASP.NET Core Identity is an extensible system which enables you to create a custom storage provider and connect it to your app.</span></span> <span data-ttu-id="a0b51-106">В этом разделе описывается создание настраиваемого поставщика хранилища для удостоверения ASP.NET Core.</span><span class="sxs-lookup"><span data-stu-id="a0b51-106">This topic describes how to create a customized storage provider for ASP.NET Core Identity.</span></span> <span data-ttu-id="a0b51-107">В нем рассматриваются важные понятия создания собственного поставщика хранилища, но не пошаговое пошаговое руководство.</span><span class="sxs-lookup"><span data-stu-id="a0b51-107">It covers the important concepts for creating your own storage provider, but isn't a step-by-step walkthrough.</span></span>

<span data-ttu-id="a0b51-108">[Просмотреть или скачать образец с GitHub](https://github.com/aspnet/AspNetCore.Docs/tree/master/aspnetcore/security/authentication/identity/sample).</span><span class="sxs-lookup"><span data-stu-id="a0b51-108">[View or download sample from GitHub](https://github.com/aspnet/AspNetCore.Docs/tree/master/aspnetcore/security/authentication/identity/sample).</span></span>

## <a name="introduction"></a><span data-ttu-id="a0b51-109">Вступление</span><span class="sxs-lookup"><span data-stu-id="a0b51-109">Introduction</span></span>

<span data-ttu-id="a0b51-110">По умолчанию система удостоверений ASP.NET Core сохраняет сведения о пользователях в базе данных SQL Server с помощью Entity Framework Core.</span><span class="sxs-lookup"><span data-stu-id="a0b51-110">By default, the ASP.NET Core Identity system stores user information in a SQL Server database using Entity Framework Core.</span></span> <span data-ttu-id="a0b51-111">Для многих приложений этот подход хорошо работает.</span><span class="sxs-lookup"><span data-stu-id="a0b51-111">For many apps, this approach works well.</span></span> <span data-ttu-id="a0b51-112">Однако можно использовать другой механизм сохраняемости или схему данных.</span><span class="sxs-lookup"><span data-stu-id="a0b51-112">However, you may prefer to use a different persistence mechanism or data schema.</span></span> <span data-ttu-id="a0b51-113">Например:</span><span class="sxs-lookup"><span data-stu-id="a0b51-113">For example:</span></span>

* <span data-ttu-id="a0b51-114">Вы используете [хранилище таблиц Azure](/azure/storage/) или другое хранилище данных.</span><span class="sxs-lookup"><span data-stu-id="a0b51-114">You use [Azure Table Storage](/azure/storage/) or another data store.</span></span>
* <span data-ttu-id="a0b51-115">Таблицы базы данных имеют различную структуру.</span><span class="sxs-lookup"><span data-stu-id="a0b51-115">Your database tables have a different structure.</span></span> 
* <span data-ttu-id="a0b51-116">Может потребоваться использовать другой подход к доступу к данным, например [Dapper](https://github.com/StackExchange/Dapper).</span><span class="sxs-lookup"><span data-stu-id="a0b51-116">You may wish to use a different data access approach, such as [Dapper](https://github.com/StackExchange/Dapper).</span></span> 

<span data-ttu-id="a0b51-117">В каждом из этих случаев можно написать настраиваемый поставщик для механизма хранения и подключить этот поставщик к приложению.</span><span class="sxs-lookup"><span data-stu-id="a0b51-117">In each of these cases, you can write a customized provider for your storage mechanism and plug that provider into your app.</span></span>

<span data-ttu-id="a0b51-118">ASP.NET Core удостоверение включается в шаблоны проектов Visual Studio с параметром "индивидуальные учетные записи пользователей".</span><span class="sxs-lookup"><span data-stu-id="a0b51-118">ASP.NET Core Identity is included in project templates in Visual Studio with the "Individual User Accounts" option.</span></span>

<span data-ttu-id="a0b51-119">При использовании .NET Core CLI добавьте `-au Individual`:</span><span class="sxs-lookup"><span data-stu-id="a0b51-119">When using the .NET Core CLI, add `-au Individual`:</span></span>

```console
dotnet new mvc -au Individual
```

## <a name="the-aspnet-core-identity-architecture"></a><span data-ttu-id="a0b51-120">Архитектура идентификации ASP.NET Core</span><span class="sxs-lookup"><span data-stu-id="a0b51-120">The ASP.NET Core Identity architecture</span></span>

<span data-ttu-id="a0b51-121">ASP.NET Core удостоверение состоит из классов, именуемых диспетчерами и хранилищами.</span><span class="sxs-lookup"><span data-stu-id="a0b51-121">ASP.NET Core Identity consists of classes called managers and stores.</span></span> <span data-ttu-id="a0b51-122">*Руководители* — это высокоуровневые классы, которые разработчик приложений использует для выполнения таких операций, как создание пользователя удостоверения.</span><span class="sxs-lookup"><span data-stu-id="a0b51-122">*Managers* are high-level classes which an app developer uses to perform operations, such as creating an Identity user.</span></span> <span data-ttu-id="a0b51-123">*Магазины* — это классы более низкого уровня, указывающие, как сохраняются сущности, например пользователи и роли.</span><span class="sxs-lookup"><span data-stu-id="a0b51-123">*Stores* are lower-level classes that specify how entities, such as users and roles, are persisted.</span></span> <span data-ttu-id="a0b51-124">Хранилища соответствуют шаблону репозитория и тесно связаны с механизмом сохраняемости.</span><span class="sxs-lookup"><span data-stu-id="a0b51-124">Stores follow the repository pattern and are closely coupled with the persistence mechanism.</span></span> <span data-ttu-id="a0b51-125">Менеджеры отделяются от магазинов, что означает возможность замены механизма сохраняемости без изменения кода приложения (кроме конфигурации).</span><span class="sxs-lookup"><span data-stu-id="a0b51-125">Managers are decoupled from stores, which means you can replace the persistence mechanism without changing your application code (except for configuration).</span></span>

<span data-ttu-id="a0b51-126">На следующей схеме показано, как веб-приложение взаимодействует с менеджерами, в то время как сохраняет взаимодействие с уровнем доступа к данным.</span><span class="sxs-lookup"><span data-stu-id="a0b51-126">The following diagram shows how a web app interacts with the managers, while stores interact with the data access layer.</span></span>

![ASP.NET Core приложения работают с менеджерами (например, "UserManager", "RoleManager").](identity-custom-storage-providers/_static/identity-architecture-diagram.png)

<span data-ttu-id="a0b51-129">Чтобы создать пользовательский поставщик хранилища, создайте источник данных, уровень доступа к данным и классы хранилища, взаимодействующие с этим уровнем доступа к данным (зеленые и серые поля на схеме выше).</span><span class="sxs-lookup"><span data-stu-id="a0b51-129">To create a custom storage provider, create the data source, the data access layer, and the store classes that interact with this data access layer (the green and grey boxes in the diagram above).</span></span> <span data-ttu-id="a0b51-130">Вам не нужно настраивать руководителей или код приложения, который взаимодействует с ними (синие ячейки выше).</span><span class="sxs-lookup"><span data-stu-id="a0b51-130">You don't need to customize the managers or your app code that interacts with them (the blue boxes above).</span></span>

<span data-ttu-id="a0b51-131">При создании нового экземпляра `UserManager` или `RoleManager` укажите тип класса User и передайте экземпляр класса Store в качестве аргумента.</span><span class="sxs-lookup"><span data-stu-id="a0b51-131">When creating a new instance of `UserManager` or `RoleManager` you provide the type of the user class and pass an instance of the store class as an argument.</span></span> <span data-ttu-id="a0b51-132">Такой подход позволяет подключать пользовательские классы к ASP.NET Core.</span><span class="sxs-lookup"><span data-stu-id="a0b51-132">This approach enables you to plug your customized classes into ASP.NET Core.</span></span> 

<span data-ttu-id="a0b51-133">[Перенастроить приложение для использования нового поставщика хранилища](#reconfigure-app-to-use-a-new-storage-provider) показывает `UserManager` , как создавать экземпляры и `RoleManager` с настроенным хранилищем.</span><span class="sxs-lookup"><span data-stu-id="a0b51-133">[Reconfigure app to use new storage provider](#reconfigure-app-to-use-a-new-storage-provider) shows how to instantiate `UserManager` and `RoleManager` with a customized store.</span></span>

## <a name="aspnet-core-identity-stores-data-types"></a><span data-ttu-id="a0b51-134">Типы данных хранилища ASP.NET Core</span><span class="sxs-lookup"><span data-stu-id="a0b51-134">ASP.NET Core Identity stores data types</span></span>

<span data-ttu-id="a0b51-135">[ASP.NET Core](https://github.com/aspnet/identity) типы данных удостоверений подробно описаны в следующих разделах:</span><span class="sxs-lookup"><span data-stu-id="a0b51-135">[ASP.NET Core Identity](https://github.com/aspnet/identity) data types are detailed in the following sections:</span></span>

### <a name="users"></a><span data-ttu-id="a0b51-136">Users</span><span class="sxs-lookup"><span data-stu-id="a0b51-136">Users</span></span>

<span data-ttu-id="a0b51-137">Зарегистрированные пользователи вашего веб-сайта.</span><span class="sxs-lookup"><span data-stu-id="a0b51-137">Registered users of your web site.</span></span> <span data-ttu-id="a0b51-138">Тип [идентитюсер](/dotnet/api/microsoft.aspnet.identity.corecompat.identityuser) можно расширить или использовать в качестве примера для собственного пользовательского типа.</span><span class="sxs-lookup"><span data-stu-id="a0b51-138">The [IdentityUser](/dotnet/api/microsoft.aspnet.identity.corecompat.identityuser) type may be extended or used as an example for your own custom type.</span></span> <span data-ttu-id="a0b51-139">Для реализации пользовательского решения для хранения удостоверений не нужно наследовать от определенного типа.</span><span class="sxs-lookup"><span data-stu-id="a0b51-139">You don't need to inherit from a particular type to implement your own custom identity storage solution.</span></span>

### <a name="user-claims"></a><span data-ttu-id="a0b51-140">Утверждения пользователей</span><span class="sxs-lookup"><span data-stu-id="a0b51-140">User Claims</span></span>

<span data-ttu-id="a0b51-141">Набор инструкций (или утверждений [](/dotnet/api/system.security.claims.claim)) о пользователе, который представляет удостоверение пользователя.</span><span class="sxs-lookup"><span data-stu-id="a0b51-141">A set of statements (or [Claims](/dotnet/api/system.security.claims.claim)) about the user that represent the user's identity.</span></span> <span data-ttu-id="a0b51-142">Можно включить большее выражение удостоверения пользователя, чем можно достичь с помощью ролей.</span><span class="sxs-lookup"><span data-stu-id="a0b51-142">Can enable greater expression of the user's identity than can be achieved through roles.</span></span>

### <a name="user-logins"></a><span data-ttu-id="a0b51-143">Имена входа пользователей</span><span class="sxs-lookup"><span data-stu-id="a0b51-143">User Logins</span></span>

<span data-ttu-id="a0b51-144">Сведения о внешнем поставщике проверки подлинности (например, Facebook или учетная запись Майкрософт), который будет использоваться для входа пользователя.</span><span class="sxs-lookup"><span data-stu-id="a0b51-144">Information about the external authentication provider (like Facebook or a Microsoft account) to use when logging in a user.</span></span> [<span data-ttu-id="a0b51-145">Пример</span><span class="sxs-lookup"><span data-stu-id="a0b51-145">Example</span></span>](/dotnet/api/microsoft.aspnet.identity.corecompat.identityuserlogin)

### <a name="roles"></a><span data-ttu-id="a0b51-146">Роли</span><span class="sxs-lookup"><span data-stu-id="a0b51-146">Roles</span></span>

<span data-ttu-id="a0b51-147">Группы авторизации для сайта.</span><span class="sxs-lookup"><span data-stu-id="a0b51-147">Authorization groups for your site.</span></span> <span data-ttu-id="a0b51-148">Содержит идентификатор роли и имя роли (например, "admin" или "Employee").</span><span class="sxs-lookup"><span data-stu-id="a0b51-148">Includes the role Id and role name (like "Admin" or "Employee").</span></span> [<span data-ttu-id="a0b51-149">Пример</span><span class="sxs-lookup"><span data-stu-id="a0b51-149">Example</span></span>](/dotnet/api/microsoft.aspnet.identity.corecompat.identityrole)

## <a name="the-data-access-layer"></a><span data-ttu-id="a0b51-150">Уровень доступа к данным</span><span class="sxs-lookup"><span data-stu-id="a0b51-150">The data access layer</span></span>

<span data-ttu-id="a0b51-151">В этом разделе предполагается, что вы знакомы с механизмом сохраняемости, который вы собираетесь использовать, и как создавать сущности для этого механизма.</span><span class="sxs-lookup"><span data-stu-id="a0b51-151">This topic assumes you are familiar with the persistence mechanism that you are going to use and how to create entities for that mechanism.</span></span> <span data-ttu-id="a0b51-152">Этот раздел не содержит сведений о создании репозиториев или классов доступа к данным. в нем приводятся некоторые рекомендации по проектированию при работе с удостоверениями ASP.NET Core.</span><span class="sxs-lookup"><span data-stu-id="a0b51-152">This topic doesn't provide details about how to create the repositories or data access classes; it provides some suggestions about design decisions when working with ASP.NET Core Identity.</span></span>

<span data-ttu-id="a0b51-153">При проектировании уровня доступа к данным для настроенного поставщика хранилища у вас есть масса свободы.</span><span class="sxs-lookup"><span data-stu-id="a0b51-153">You have a lot of freedom when designing the data access layer for a customized store provider.</span></span> <span data-ttu-id="a0b51-154">Для функций, которые предполагается использовать в приложении, необходимо создать только механизмы сохраняемости.</span><span class="sxs-lookup"><span data-stu-id="a0b51-154">You only need to create persistence mechanisms for features that you intend to use in your app.</span></span> <span data-ttu-id="a0b51-155">Например, если вы не используете роли в приложении, вам не нужно создавать хранилище для ролей или ассоциаций ролей пользователей.</span><span class="sxs-lookup"><span data-stu-id="a0b51-155">For example, if you are not using roles in your app, you don't need to create storage for roles or user role associations.</span></span> <span data-ttu-id="a0b51-156">Для вашей технологии и существующей инфраструктуры может потребоваться структура, которая сильно отличается от стандартной реализации удостоверения ASP.NET Core.</span><span class="sxs-lookup"><span data-stu-id="a0b51-156">Your technology and existing infrastructure may require a structure that's very different from the default implementation of ASP.NET Core Identity.</span></span> <span data-ttu-id="a0b51-157">На уровне доступа к данным вы предоставляете логику для работы со структурой реализации хранилища.</span><span class="sxs-lookup"><span data-stu-id="a0b51-157">In your data access layer, you provide the logic to work with the structure of your storage implementation.</span></span>

<span data-ttu-id="a0b51-158">Уровень доступа к данным предоставляет логику для сохранения данных из ASP.NET Core удостоверения в источнике данных.</span><span class="sxs-lookup"><span data-stu-id="a0b51-158">The data access layer provides the logic to save the data from ASP.NET Core Identity to a data source.</span></span> <span data-ttu-id="a0b51-159">Уровень доступа к данным для настроенного поставщика хранилища может включать следующие классы для хранения сведений о пользователях и ролях.</span><span class="sxs-lookup"><span data-stu-id="a0b51-159">The data access layer for your customized storage provider might include the following classes to store user and role information.</span></span>

### <a name="context-class"></a><span data-ttu-id="a0b51-160">Context - класс</span><span class="sxs-lookup"><span data-stu-id="a0b51-160">Context class</span></span>

<span data-ttu-id="a0b51-161">Инкапсулирует сведения для подключения к механизму сохранения и выполнения запросов.</span><span class="sxs-lookup"><span data-stu-id="a0b51-161">Encapsulates the information to connect to your persistence mechanism and execute queries.</span></span> <span data-ttu-id="a0b51-162">Для нескольких классов данных требуется экземпляр этого класса, который обычно предоставляется посредством внедрения зависимостей.</span><span class="sxs-lookup"><span data-stu-id="a0b51-162">Several data classes require an instance of this class, typically provided through dependency injection.</span></span> <span data-ttu-id="a0b51-163">[Пример](/dotnet/api/microsoft.aspnet.identity.corecompat.identitydbcontext-1).</span><span class="sxs-lookup"><span data-stu-id="a0b51-163">[Example](/dotnet/api/microsoft.aspnet.identity.corecompat.identitydbcontext-1).</span></span>

### <a name="user-storage"></a><span data-ttu-id="a0b51-164">Хранилище пользователя</span><span class="sxs-lookup"><span data-stu-id="a0b51-164">User Storage</span></span>

<span data-ttu-id="a0b51-165">Сохраняет и извлекает сведения о пользователе (например, имя пользователя и хэш пароля).</span><span class="sxs-lookup"><span data-stu-id="a0b51-165">Stores and retrieves user information (such as user name and password hash).</span></span> [<span data-ttu-id="a0b51-166">Пример</span><span class="sxs-lookup"><span data-stu-id="a0b51-166">Example</span></span>](/dotnet/api/microsoft.aspnet.identity.corecompat.userstore-1)

### <a name="role-storage"></a><span data-ttu-id="a0b51-167">Хранилище ролей</span><span class="sxs-lookup"><span data-stu-id="a0b51-167">Role Storage</span></span>

<span data-ttu-id="a0b51-168">Сохраняет и извлекает сведения о ролях (например, имя роли).</span><span class="sxs-lookup"><span data-stu-id="a0b51-168">Stores and retrieves role information (such as the role name).</span></span> [<span data-ttu-id="a0b51-169">Пример</span><span class="sxs-lookup"><span data-stu-id="a0b51-169">Example</span></span>](/dotnet/api/microsoft.aspnetcore.identity.entityframeworkcore.rolestore-1)

### <a name="userclaims-storage"></a><span data-ttu-id="a0b51-170">Хранилище Усерклаимс</span><span class="sxs-lookup"><span data-stu-id="a0b51-170">UserClaims Storage</span></span>

<span data-ttu-id="a0b51-171">Сохраняет и извлекает сведения о пользовательской заявке (например, тип и значение утверждения).</span><span class="sxs-lookup"><span data-stu-id="a0b51-171">Stores and retrieves user claim information (such as the claim type and value).</span></span> [<span data-ttu-id="a0b51-172">Пример</span><span class="sxs-lookup"><span data-stu-id="a0b51-172">Example</span></span>](/dotnet/api/microsoft.aspnet.identity.corecompat.userstore-1)

### <a name="userlogins-storage"></a><span data-ttu-id="a0b51-173">Хранилище Усерлогинс</span><span class="sxs-lookup"><span data-stu-id="a0b51-173">UserLogins Storage</span></span>

<span data-ttu-id="a0b51-174">Хранит и получает сведения для входа пользователя (например, внешний поставщик проверки подлинности).</span><span class="sxs-lookup"><span data-stu-id="a0b51-174">Stores and retrieves user login information (such as an external authentication provider).</span></span> [<span data-ttu-id="a0b51-175">Пример</span><span class="sxs-lookup"><span data-stu-id="a0b51-175">Example</span></span>](/dotnet/api/microsoft.aspnet.identity.corecompat.userstore-1)

### <a name="userrole-storage"></a><span data-ttu-id="a0b51-176">Хранилище UserRole</span><span class="sxs-lookup"><span data-stu-id="a0b51-176">UserRole Storage</span></span>

<span data-ttu-id="a0b51-177">Сохраняет и извлекает роли, назначенные пользователям.</span><span class="sxs-lookup"><span data-stu-id="a0b51-177">Stores and retrieves which roles are assigned to which users.</span></span> [<span data-ttu-id="a0b51-178">Пример</span><span class="sxs-lookup"><span data-stu-id="a0b51-178">Example</span></span>](/dotnet/api/microsoft.aspnet.identity.corecompat.userstore-1)

<span data-ttu-id="a0b51-179">**СОВЕТЫ** Реализуйте только те классы, которые планируется использовать в приложении.</span><span class="sxs-lookup"><span data-stu-id="a0b51-179">**TIP:** Only implement the classes you intend to use in your app.</span></span>

<span data-ttu-id="a0b51-180">В классах доступа к данным укажите код для выполнения операций с данными в механизме сохраняемости.</span><span class="sxs-lookup"><span data-stu-id="a0b51-180">In the data access classes, provide code to perform data operations for your persistence mechanism.</span></span> <span data-ttu-id="a0b51-181">Например, в настраиваемом поставщике может быть создан следующий код для создания пользователя в классе *Store* :</span><span class="sxs-lookup"><span data-stu-id="a0b51-181">For example, within a custom provider, you might have the following code to create a new user in the *store* class:</span></span>

[!code-csharp[](identity-custom-storage-providers/sample/CustomIdentityProviderSample/CustomProvider/CustomUserStore.cs?name=createuser&highlight=7)]

<span data-ttu-id="a0b51-182">Логика реализации для создания пользователя находится в `_usersTable.CreateAsync` методе, показанном ниже.</span><span class="sxs-lookup"><span data-stu-id="a0b51-182">The implementation logic for creating the user is in the `_usersTable.CreateAsync` method, shown below.</span></span>

## <a name="customize-the-user-class"></a><span data-ttu-id="a0b51-183">Настройка класса User</span><span class="sxs-lookup"><span data-stu-id="a0b51-183">Customize the user class</span></span>

<span data-ttu-id="a0b51-184">При реализации поставщика хранилища создайте класс пользователя, эквивалентный [классу идентитюсер](/dotnet/api/microsoft.aspnet.identity.corecompat.identityuser).</span><span class="sxs-lookup"><span data-stu-id="a0b51-184">When implementing a storage provider, create a user class which is equivalent to the [IdentityUser class](/dotnet/api/microsoft.aspnet.identity.corecompat.identityuser).</span></span>

<span data-ttu-id="a0b51-185">Как минимум, класс пользователя должен включать `Id` `UserName` свойство и.</span><span class="sxs-lookup"><span data-stu-id="a0b51-185">At a minimum, your user class must include an `Id` and a `UserName` property.</span></span>

<span data-ttu-id="a0b51-186">Класс определяет свойства `UserManager` , которые вызываются при выполнении запрошенных операций. `IdentityUser`</span><span class="sxs-lookup"><span data-stu-id="a0b51-186">The `IdentityUser` class defines the properties that the `UserManager` calls when performing requested operations.</span></span> <span data-ttu-id="a0b51-187">По умолчанию `Id` свойство имеет тип String, но можно наследовать от `IdentityUser<TKey, TUserClaim, TUserRole, TUserLogin, TUserToken>` и указать другой тип.</span><span class="sxs-lookup"><span data-stu-id="a0b51-187">The default type of the `Id` property is a string, but you can inherit from `IdentityUser<TKey, TUserClaim, TUserRole, TUserLogin, TUserToken>` and specify a different type.</span></span> <span data-ttu-id="a0b51-188">Платформа должна обеспечивать реализацию хранилища для преобразования типов данных.</span><span class="sxs-lookup"><span data-stu-id="a0b51-188">The framework expects the storage implementation to handle data type conversions.</span></span>

## <a name="customize-the-user-store"></a><span data-ttu-id="a0b51-189">Настройка хранилища пользователей</span><span class="sxs-lookup"><span data-stu-id="a0b51-189">Customize the user store</span></span>

<span data-ttu-id="a0b51-190">`UserStore` Создайте класс, предоставляющий методы для всех операций с данными пользователя.</span><span class="sxs-lookup"><span data-stu-id="a0b51-190">Create a `UserStore` class that provides the methods for all data operations on the user.</span></span> <span data-ttu-id="a0b51-191">Этот класс эквивалентен классу [Тусер&lt;&gt; UserStore](/dotnet/api/microsoft.aspnetcore.identity.entityframeworkcore.userstore-1) .</span><span class="sxs-lookup"><span data-stu-id="a0b51-191">This class is equivalent to the [UserStore&lt;TUser&gt;](/dotnet/api/microsoft.aspnetcore.identity.entityframeworkcore.userstore-1) class.</span></span> <span data-ttu-id="a0b51-192">В классе реализуйте `IUserStore<TUser>` и необходимые дополнительные интерфейсы. `UserStore`</span><span class="sxs-lookup"><span data-stu-id="a0b51-192">In your `UserStore` class, implement `IUserStore<TUser>` and the optional interfaces required.</span></span> <span data-ttu-id="a0b51-193">Выбор дополнительных интерфейсов для реализации зависит от функциональности, предоставляемой в приложении.</span><span class="sxs-lookup"><span data-stu-id="a0b51-193">You select which optional interfaces to implement based on the functionality provided in your app.</span></span>

### <a name="optional-interfaces"></a><span data-ttu-id="a0b51-194">Необязательные интерфейсы</span><span class="sxs-lookup"><span data-stu-id="a0b51-194">Optional interfaces</span></span>

* [<span data-ttu-id="a0b51-195">IUserRoleStore</span><span class="sxs-lookup"><span data-stu-id="a0b51-195">IUserRoleStore</span></span>](/dotnet/api/microsoft.aspnetcore.identity.iuserrolestore-1)
* [<span data-ttu-id="a0b51-196">IUserClaimStore</span><span class="sxs-lookup"><span data-stu-id="a0b51-196">IUserClaimStore</span></span>](/dotnet/api/microsoft.aspnetcore.identity.iuserclaimstore-1)
* [<span data-ttu-id="a0b51-197">IUserPasswordStore</span><span class="sxs-lookup"><span data-stu-id="a0b51-197">IUserPasswordStore</span></span>](/dotnet/api/microsoft.aspnetcore.identity.iuserpasswordstore-1)
* [<span data-ttu-id="a0b51-198">иусерсекуритистампсторе</span><span class="sxs-lookup"><span data-stu-id="a0b51-198">IUserSecurityStampStore</span></span>](/dotnet/api/microsoft.aspnetcore.identity.iusersecuritystampstore-1)
* [<span data-ttu-id="a0b51-199">иусеремаилсторе</span><span class="sxs-lookup"><span data-stu-id="a0b51-199">IUserEmailStore</span></span>](/dotnet/api/microsoft.aspnetcore.identity.iuseremailstore-1)
* [<span data-ttu-id="a0b51-200">иусерфоненумберсторе</span><span class="sxs-lookup"><span data-stu-id="a0b51-200">IUserPhoneNumberStore</span></span>](/dotnet/api/microsoft.aspnetcore.identity.iuserphonenumberstore-1)
* [<span data-ttu-id="a0b51-201">IQueryableUserStore</span><span class="sxs-lookup"><span data-stu-id="a0b51-201">IQueryableUserStore</span></span>](/dotnet/api/microsoft.aspnetcore.identity.iqueryableuserstore-1)
* [<span data-ttu-id="a0b51-202">иусерлогинсторе</span><span class="sxs-lookup"><span data-stu-id="a0b51-202">IUserLoginStore</span></span>](/dotnet/api/microsoft.aspnetcore.identity.iuserloginstore-1)
* [<span data-ttu-id="a0b51-203">IUserTwoFactorStore</span><span class="sxs-lookup"><span data-stu-id="a0b51-203">IUserTwoFactorStore</span></span>](/dotnet/api/microsoft.aspnetcore.identity.iusertwofactorstore-1)
* [<span data-ttu-id="a0b51-204">иусерлоккаутсторе</span><span class="sxs-lookup"><span data-stu-id="a0b51-204">IUserLockoutStore</span></span>](/dotnet/api/microsoft.aspnetcore.identity.iuserlockoutstore-1)

<span data-ttu-id="a0b51-205">Необязательные интерфейсы наследуются от `IUserStore<TUser>`.</span><span class="sxs-lookup"><span data-stu-id="a0b51-205">The optional interfaces inherit from `IUserStore<TUser>`.</span></span> <span data-ttu-id="a0b51-206">В [примере приложения](https://github.com/aspnet/AspNetCore.Docs/blob/master/aspnetcore/security/authentication/identity-custom-storage-providers/sample/CustomIdentityProviderSample/CustomProvider/CustomUserStore.cs)можно увидеть частично реализованное хранилище пользователей с примером.</span><span class="sxs-lookup"><span data-stu-id="a0b51-206">You can see a partially implemented sample user store in the [sample app](https://github.com/aspnet/AspNetCore.Docs/blob/master/aspnetcore/security/authentication/identity-custom-storage-providers/sample/CustomIdentityProviderSample/CustomProvider/CustomUserStore.cs).</span></span>

<span data-ttu-id="a0b51-207">В рамках `UserStore` класса используются классы доступа к данным, созданные для выполнения операций.</span><span class="sxs-lookup"><span data-stu-id="a0b51-207">Within the `UserStore` class, you use the data access classes that you created to perform operations.</span></span> <span data-ttu-id="a0b51-208">Они передаются при помощи внедрения зависимостей.</span><span class="sxs-lookup"><span data-stu-id="a0b51-208">These are passed in using dependency injection.</span></span> <span data-ttu-id="a0b51-209">Например, в SQL Server с реализацией `UserStore` Dapper класс `CreateAsync` содержит метод, `DapperUsersTable` который использует экземпляр для вставки новой записи:</span><span class="sxs-lookup"><span data-stu-id="a0b51-209">For example, in the SQL Server with Dapper implementation, the `UserStore` class has the `CreateAsync` method which uses an instance of `DapperUsersTable` to insert a new record:</span></span>

[!code-csharp[](identity-custom-storage-providers/sample/CustomIdentityProviderSample/CustomProvider/DapperUsersTable.cs?name=createuser&highlight=7)]

### <a name="interfaces-to-implement-when-customizing-user-store"></a><span data-ttu-id="a0b51-210">Интерфейсы, реализуемые при настройке хранилища пользователей</span><span class="sxs-lookup"><span data-stu-id="a0b51-210">Interfaces to implement when customizing user store</span></span>

* <span data-ttu-id="a0b51-211">**IUserStore**</span><span class="sxs-lookup"><span data-stu-id="a0b51-211">**IUserStore**</span></span>  
 <span data-ttu-id="a0b51-212">Интерфейс [IUserStore&lt;Тусер&gt; ](/dotnet/api/microsoft.aspnetcore.identity.iuserstore-1) является единственным интерфейсом, который необходимо реализовать в хранилище пользователя.</span><span class="sxs-lookup"><span data-stu-id="a0b51-212">The [IUserStore&lt;TUser&gt;](/dotnet/api/microsoft.aspnetcore.identity.iuserstore-1) interface is the only interface you must implement in the user store.</span></span> <span data-ttu-id="a0b51-213">Он определяет методы для создания, обновления, удаления и получения пользователей.</span><span class="sxs-lookup"><span data-stu-id="a0b51-213">It defines methods for creating, updating, deleting, and retrieving users.</span></span>
* <span data-ttu-id="a0b51-214">**IUserClaimStore**</span><span class="sxs-lookup"><span data-stu-id="a0b51-214">**IUserClaimStore**</span></span>  
 <span data-ttu-id="a0b51-215">Интерфейс [IUserClaimStore&lt;Тусер&gt; ](/dotnet/api/microsoft.aspnetcore.identity.iuserclaimstore-1) определяет методы, которые реализуются для включения заявок пользователя.</span><span class="sxs-lookup"><span data-stu-id="a0b51-215">The [IUserClaimStore&lt;TUser&gt;](/dotnet/api/microsoft.aspnetcore.identity.iuserclaimstore-1) interface defines the methods you implement to enable user claims.</span></span> <span data-ttu-id="a0b51-216">Он содержит методы для добавления, удаления и получения утверждений пользователей.</span><span class="sxs-lookup"><span data-stu-id="a0b51-216">It contains methods for adding, removing and retrieving user claims.</span></span>
* <span data-ttu-id="a0b51-217">**иусерлогинсторе**</span><span class="sxs-lookup"><span data-stu-id="a0b51-217">**IUserLoginStore**</span></span>  
 <span data-ttu-id="a0b51-218">[Иусерлогинсторе&lt;Тусер&gt; ](/dotnet/api/microsoft.aspnetcore.identity.iuserloginstore-1) определяет методы, которые реализуются для включения внешних поставщиков проверки подлинности.</span><span class="sxs-lookup"><span data-stu-id="a0b51-218">The [IUserLoginStore&lt;TUser&gt;](/dotnet/api/microsoft.aspnetcore.identity.iuserloginstore-1) defines the methods you implement to enable external authentication providers.</span></span> <span data-ttu-id="a0b51-219">Он содержит методы для добавления, удаления и получения имен входа пользователей, а также метод для получения пользователя на основе сведений об имени входа.</span><span class="sxs-lookup"><span data-stu-id="a0b51-219">It contains methods for adding, removing and retrieving user logins, and a method for retrieving a user based on the login information.</span></span>
* <span data-ttu-id="a0b51-220">**IUserRoleStore**</span><span class="sxs-lookup"><span data-stu-id="a0b51-220">**IUserRoleStore**</span></span>  
 <span data-ttu-id="a0b51-221">Интерфейс [IUserRoleStore&lt;Тусер&gt; ](/dotnet/api/microsoft.aspnetcore.identity.iuserrolestore-1) определяет методы, которые реализуются для соотнесения пользователя с ролью.</span><span class="sxs-lookup"><span data-stu-id="a0b51-221">The [IUserRoleStore&lt;TUser&gt;](/dotnet/api/microsoft.aspnetcore.identity.iuserrolestore-1) interface defines the methods you implement to map a user to a role.</span></span> <span data-ttu-id="a0b51-222">Он содержит методы для добавления, удаления и получения ролей пользователя, а также метод для проверки того, назначен ли пользователю роль.</span><span class="sxs-lookup"><span data-stu-id="a0b51-222">It contains methods to add, remove, and retrieve a user's roles, and a method to check if a user is assigned to a role.</span></span>
* <span data-ttu-id="a0b51-223">**IUserPasswordStore**</span><span class="sxs-lookup"><span data-stu-id="a0b51-223">**IUserPasswordStore**</span></span>  
 <span data-ttu-id="a0b51-224">Интерфейс [IUserPasswordStore&lt;Тусер&gt; ](/dotnet/api/microsoft.aspnetcore.identity.iuserpasswordstore-1) определяет методы, которые реализуются для сохранения хэшированных паролей.</span><span class="sxs-lookup"><span data-stu-id="a0b51-224">The [IUserPasswordStore&lt;TUser&gt;](/dotnet/api/microsoft.aspnetcore.identity.iuserpasswordstore-1) interface defines the methods you implement to persist hashed passwords.</span></span> <span data-ttu-id="a0b51-225">Он содержит методы для получения и установки хэшированного пароля, а также метод, который указывает, установил ли пользователь пароль.</span><span class="sxs-lookup"><span data-stu-id="a0b51-225">It contains methods for getting and setting the hashed password, and a method that indicates whether the user has set a password.</span></span>
* <span data-ttu-id="a0b51-226">**иусерсекуритистампсторе**</span><span class="sxs-lookup"><span data-stu-id="a0b51-226">**IUserSecurityStampStore**</span></span>  
 <span data-ttu-id="a0b51-227">Интерфейс [иусерсекуритистампсторе&lt;Тусер&gt; ](/dotnet/api/microsoft.aspnetcore.identity.iusersecuritystampstore-1) определяет методы, которые вы реализуете для использования метки безопасности для указания, изменились ли сведения об учетной записи пользователя.</span><span class="sxs-lookup"><span data-stu-id="a0b51-227">The [IUserSecurityStampStore&lt;TUser&gt;](/dotnet/api/microsoft.aspnetcore.identity.iusersecuritystampstore-1) interface defines the methods you implement to use a security stamp for indicating whether the user's account information has changed.</span></span> <span data-ttu-id="a0b51-228">Эта метка обновляется, когда пользователь изменяет пароль или добавляет или удаляет имена входа.</span><span class="sxs-lookup"><span data-stu-id="a0b51-228">This stamp is updated when a user changes the password, or adds or removes logins.</span></span> <span data-ttu-id="a0b51-229">Он содержит методы для получения и установки метки безопасности.</span><span class="sxs-lookup"><span data-stu-id="a0b51-229">It contains methods for getting and setting the security stamp.</span></span>
* <span data-ttu-id="a0b51-230">**IUserTwoFactorStore**</span><span class="sxs-lookup"><span data-stu-id="a0b51-230">**IUserTwoFactorStore**</span></span>  
 <span data-ttu-id="a0b51-231">Интерфейс [IUserTwoFactorStore&lt;Тусер&gt; ](/dotnet/api/microsoft.aspnetcore.identity.iusertwofactorstore-1) определяет методы, которые реализуются для поддержки двухфакторной проверки подлинности.</span><span class="sxs-lookup"><span data-stu-id="a0b51-231">The [IUserTwoFactorStore&lt;TUser&gt;](/dotnet/api/microsoft.aspnetcore.identity.iusertwofactorstore-1) interface defines the methods you implement to support two factor authentication.</span></span> <span data-ttu-id="a0b51-232">Он содержит методы для получения и настройки проверки подлинности, включенной для пользователя.</span><span class="sxs-lookup"><span data-stu-id="a0b51-232">It contains methods for getting and setting whether two factor authentication is enabled for a user.</span></span>
* <span data-ttu-id="a0b51-233">**иусерфоненумберсторе**</span><span class="sxs-lookup"><span data-stu-id="a0b51-233">**IUserPhoneNumberStore**</span></span>  
 <span data-ttu-id="a0b51-234">Интерфейс [иусерфоненумберсторе&lt;Тусер&gt; ](/dotnet/api/microsoft.aspnetcore.identity.iuserphonenumberstore-1) определяет методы, которые вы реализуете для хранения телефонных номеров пользователей.</span><span class="sxs-lookup"><span data-stu-id="a0b51-234">The [IUserPhoneNumberStore&lt;TUser&gt;](/dotnet/api/microsoft.aspnetcore.identity.iuserphonenumberstore-1) interface defines the methods you implement to store user phone numbers.</span></span> <span data-ttu-id="a0b51-235">Он содержит методы для получения и установки номера телефона, а также сведения о подтверждении номера телефона.</span><span class="sxs-lookup"><span data-stu-id="a0b51-235">It contains methods for getting and setting the phone number and whether the phone number is confirmed.</span></span>
* <span data-ttu-id="a0b51-236">**иусеремаилсторе**</span><span class="sxs-lookup"><span data-stu-id="a0b51-236">**IUserEmailStore**</span></span>  
 <span data-ttu-id="a0b51-237">Интерфейс [иусеремаилсторе&lt;Тусер&gt; ](/dotnet/api/microsoft.aspnetcore.identity.iuseremailstore-1) определяет методы, которые вы реализуете для хранения адресов электронной почты пользователей.</span><span class="sxs-lookup"><span data-stu-id="a0b51-237">The [IUserEmailStore&lt;TUser&gt;](/dotnet/api/microsoft.aspnetcore.identity.iuseremailstore-1) interface defines the methods you implement to store user email addresses.</span></span> <span data-ttu-id="a0b51-238">Он содержит методы для получения и установки адреса электронной почты, а также сведения о том, подтверждено ли сообщение электронной почты.</span><span class="sxs-lookup"><span data-stu-id="a0b51-238">It contains methods for getting and setting the email address and whether the email is confirmed.</span></span>
* <span data-ttu-id="a0b51-239">**иусерлоккаутсторе**</span><span class="sxs-lookup"><span data-stu-id="a0b51-239">**IUserLockoutStore**</span></span>  
 <span data-ttu-id="a0b51-240">Интерфейс [иусерлоккаутсторе&lt;Тусер&gt; ](/dotnet/api/microsoft.aspnetcore.identity.iuserlockoutstore-1) определяет методы, которые вы реализуете для хранения сведений о блокировке учетной записи.</span><span class="sxs-lookup"><span data-stu-id="a0b51-240">The [IUserLockoutStore&lt;TUser&gt;](/dotnet/api/microsoft.aspnetcore.identity.iuserlockoutstore-1) interface defines the methods you implement to store information about locking an account.</span></span> <span data-ttu-id="a0b51-241">Он содержит методы для отслеживания неудачных попыток доступа и блокировки.</span><span class="sxs-lookup"><span data-stu-id="a0b51-241">It contains methods for tracking failed access attempts and lockouts.</span></span>
* <span data-ttu-id="a0b51-242">**IQueryableUserStore**</span><span class="sxs-lookup"><span data-stu-id="a0b51-242">**IQueryableUserStore**</span></span>  
 <span data-ttu-id="a0b51-243">Интерфейс [IQueryableUserStore&lt;Тусер&gt; ](/dotnet/api/microsoft.aspnetcore.identity.iqueryableuserstore-1) определяет элементы, которые вы реализуете для предоставления запрашиваемого хранилища пользователя.</span><span class="sxs-lookup"><span data-stu-id="a0b51-243">The [IQueryableUserStore&lt;TUser&gt;](/dotnet/api/microsoft.aspnetcore.identity.iqueryableuserstore-1) interface defines the members you implement to provide a queryable user store.</span></span>

<span data-ttu-id="a0b51-244">Вы реализуете только те интерфейсы, которые необходимы в приложении.</span><span class="sxs-lookup"><span data-stu-id="a0b51-244">You implement only the interfaces that are needed in your app.</span></span> <span data-ttu-id="a0b51-245">Например:</span><span class="sxs-lookup"><span data-stu-id="a0b51-245">For example:</span></span>

```csharp
public class UserStore : IUserStore<IdentityUser>,
                         IUserClaimStore<IdentityUser>,
                         IUserLoginStore<IdentityUser>,
                         IUserRoleStore<IdentityUser>,
                         IUserPasswordStore<IdentityUser>,
                         IUserSecurityStampStore<IdentityUser>
{
    // interface implementations not shown
}
```

### <a name="identityuserclaim-identityuserlogin-and-identityuserrole"></a><span data-ttu-id="a0b51-246">Идентитюсерклаим, Идентитюсерлогин и Идентитюсерроле</span><span class="sxs-lookup"><span data-stu-id="a0b51-246">IdentityUserClaim, IdentityUserLogin, and IdentityUserRole</span></span>

<span data-ttu-id="a0b51-247">Пространство имен содержит реализации классов [идентитюсерклаим](/dotnet/api/microsoft.aspnetcore.identity.entityframeworkcore.identityuserclaim-1), [идентитюсерлогин](/dotnet/api/microsoft.aspnet.identity.corecompat.identityuserlogin)и [идентитюсерроле.](/dotnet/api/microsoft.aspnetcore.identity.entityframeworkcore.identityuserrole-1) `Microsoft.AspNet.Identity.EntityFramework`</span><span class="sxs-lookup"><span data-stu-id="a0b51-247">The `Microsoft.AspNet.Identity.EntityFramework` namespace contains implementations of the [IdentityUserClaim](/dotnet/api/microsoft.aspnetcore.identity.entityframeworkcore.identityuserclaim-1), [IdentityUserLogin](/dotnet/api/microsoft.aspnet.identity.corecompat.identityuserlogin), and [IdentityUserRole](/dotnet/api/microsoft.aspnetcore.identity.entityframeworkcore.identityuserrole-1) classes.</span></span> <span data-ttu-id="a0b51-248">При использовании этих функций может потребоваться создать собственные версии этих классов и определить свойства приложения.</span><span class="sxs-lookup"><span data-stu-id="a0b51-248">If you are using these features, you may want to create your own versions of these classes and define the properties for your app.</span></span> <span data-ttu-id="a0b51-249">Однако иногда эффективнее не загружать эти сущности в память при выполнении основных операций (например, при добавлении или удалении утверждения пользователя).</span><span class="sxs-lookup"><span data-stu-id="a0b51-249">However, sometimes it's more efficient to not load these entities into memory when performing basic operations (such as adding or removing a user's claim).</span></span> <span data-ttu-id="a0b51-250">Вместо этого классы хранилища серверной части могут выполнять эти операции непосредственно в источнике данных.</span><span class="sxs-lookup"><span data-stu-id="a0b51-250">Instead, the backend store classes can execute these operations directly on the data source.</span></span> <span data-ttu-id="a0b51-251">Например, `UserStore.GetClaimsAsync` метод может `userClaimTable.FindByUserId(user.Id)` вызвать метод, чтобы выполнить запрос к этой таблице напрямую и вернуть список заявок.</span><span class="sxs-lookup"><span data-stu-id="a0b51-251">For example, the `UserStore.GetClaimsAsync` method can call the `userClaimTable.FindByUserId(user.Id)` method to execute a query on that table directly and return a list of claims.</span></span>

## <a name="customize-the-role-class"></a><span data-ttu-id="a0b51-252">Настройка класса Role</span><span class="sxs-lookup"><span data-stu-id="a0b51-252">Customize the role class</span></span>

<span data-ttu-id="a0b51-253">При реализации поставщика хранилища ролей можно создать пользовательский тип роли.</span><span class="sxs-lookup"><span data-stu-id="a0b51-253">When implementing a role storage provider, you can create a custom role type.</span></span> <span data-ttu-id="a0b51-254">Он не должен реализовывать определенный интерфейс, но у него должна быть `Id` и, как правило `Name` , свойство.</span><span class="sxs-lookup"><span data-stu-id="a0b51-254">It need not implement a particular interface, but it must have an `Id` and typically it will have a `Name` property.</span></span>

<span data-ttu-id="a0b51-255">Ниже приведен пример класса role:</span><span class="sxs-lookup"><span data-stu-id="a0b51-255">The following is an example role class:</span></span>

[!code-csharp[](identity-custom-storage-providers/sample/CustomIdentityProviderSample/CustomProvider/ApplicationRole.cs)]

## <a name="customize-the-role-store"></a><span data-ttu-id="a0b51-256">Настройка хранилища ролей</span><span class="sxs-lookup"><span data-stu-id="a0b51-256">Customize the role store</span></span>

<span data-ttu-id="a0b51-257">Можно создать `RoleStore` класс, предоставляющий методы для всех операций с данными в ролях.</span><span class="sxs-lookup"><span data-stu-id="a0b51-257">You can create a `RoleStore` class that provides the methods for all data operations on roles.</span></span> <span data-ttu-id="a0b51-258">Этот класс эквивалентен классу [троле&lt;&gt; ролесторе](/dotnet/api/microsoft.aspnetcore.identity.entityframeworkcore.rolestore-1) .</span><span class="sxs-lookup"><span data-stu-id="a0b51-258">This class is equivalent to the [RoleStore&lt;TRole&gt;](/dotnet/api/microsoft.aspnetcore.identity.entityframeworkcore.rolestore-1) class.</span></span> <span data-ttu-id="a0b51-259">В классе реализуется и, при необходимости, `IQueryableRoleStore<TRole>` интерфейс. `IRoleStore<TRole>` `RoleStore`</span><span class="sxs-lookup"><span data-stu-id="a0b51-259">In the `RoleStore` class, you implement the `IRoleStore<TRole>` and optionally the `IQueryableRoleStore<TRole>` interface.</span></span>

* <span data-ttu-id="a0b51-260">**Иролесторе&lt;троле&gt;**</span><span class="sxs-lookup"><span data-stu-id="a0b51-260">**IRoleStore&lt;TRole&gt;**</span></span>  
 <span data-ttu-id="a0b51-261">Интерфейс [иролесторе&lt;троле&gt; ](/dotnet/api/microsoft.aspnetcore.identity.irolestore-1) определяет методы для реализации в классе хранилища ролей.</span><span class="sxs-lookup"><span data-stu-id="a0b51-261">The [IRoleStore&lt;TRole&gt;](/dotnet/api/microsoft.aspnetcore.identity.irolestore-1) interface defines the methods to implement in the role store class.</span></span> <span data-ttu-id="a0b51-262">Он содержит методы для создания, обновления, удаления и получения ролей.</span><span class="sxs-lookup"><span data-stu-id="a0b51-262">It contains methods for creating, updating, deleting, and retrieving roles.</span></span>
* <span data-ttu-id="a0b51-263">**Ролесторе&lt;троле&gt;**</span><span class="sxs-lookup"><span data-stu-id="a0b51-263">**RoleStore&lt;TRole&gt;**</span></span>  
 <span data-ttu-id="a0b51-264">Чтобы настроить `RoleStore`, создайте класс, `IRoleStore<TRole>` реализующий интерфейс.</span><span class="sxs-lookup"><span data-stu-id="a0b51-264">To customize `RoleStore`, create a class that implements the `IRoleStore<TRole>` interface.</span></span> 

## <a name="reconfigure-app-to-use-a-new-storage-provider"></a><span data-ttu-id="a0b51-265">Перенастройте приложение для использования нового поставщика хранилища</span><span class="sxs-lookup"><span data-stu-id="a0b51-265">Reconfigure app to use a new storage provider</span></span>

<span data-ttu-id="a0b51-266">После реализации поставщика хранилища вы настраиваете приложение для его использования.</span><span class="sxs-lookup"><span data-stu-id="a0b51-266">Once you have implemented a storage provider, you configure your app to use it.</span></span> <span data-ttu-id="a0b51-267">Если приложение использовало поставщика по умолчанию, замените его пользовательским поставщиком.</span><span class="sxs-lookup"><span data-stu-id="a0b51-267">If your app used the default provider, replace it with your custom provider.</span></span>

1. <span data-ttu-id="a0b51-268">Удалите пакет `Microsoft.AspNetCore.EntityFramework.Identity` NuGet.</span><span class="sxs-lookup"><span data-stu-id="a0b51-268">Remove the `Microsoft.AspNetCore.EntityFramework.Identity` NuGet package.</span></span>
1. <span data-ttu-id="a0b51-269">Если поставщик хранилища находится в отдельном проекте или пакете, добавьте ссылку на него.</span><span class="sxs-lookup"><span data-stu-id="a0b51-269">If the storage provider resides in a separate project or package, add a reference to it.</span></span>
1. <span data-ttu-id="a0b51-270">Замените все ссылки на `Microsoft.AspNetCore.EntityFramework.Identity` оператор using для пространства имен поставщика хранилища.</span><span class="sxs-lookup"><span data-stu-id="a0b51-270">Replace all references to `Microsoft.AspNetCore.EntityFramework.Identity` with a using statement for the namespace of your storage provider.</span></span>
1. <span data-ttu-id="a0b51-271">В методе `AddIdentity` измените метод, чтобы использовать пользовательские типы. `ConfigureServices`</span><span class="sxs-lookup"><span data-stu-id="a0b51-271">In the `ConfigureServices` method, change the `AddIdentity` method to use your custom types.</span></span> <span data-ttu-id="a0b51-272">Для этой цели можно создать собственные методы расширения.</span><span class="sxs-lookup"><span data-stu-id="a0b51-272">You can create your own extension methods for this purpose.</span></span> <span data-ttu-id="a0b51-273">Пример см. в разделе [идентитисервицеколлектионекстенсионс](https://github.com/aspnet/Identity/blob/rel/1.1.0/src/Microsoft.AspNetCore.Identity/IdentityServiceCollectionExtensions.cs) .</span><span class="sxs-lookup"><span data-stu-id="a0b51-273">See [IdentityServiceCollectionExtensions](https://github.com/aspnet/Identity/blob/rel/1.1.0/src/Microsoft.AspNetCore.Identity/IdentityServiceCollectionExtensions.cs) for an example.</span></span>
1. <span data-ttu-id="a0b51-274">Если вы используете роли, обновите, `RoleManager` чтобы использовать свой `RoleStore` класс.</span><span class="sxs-lookup"><span data-stu-id="a0b51-274">If you are using Roles, update the `RoleManager` to use your `RoleStore` class.</span></span>
1. <span data-ttu-id="a0b51-275">Обновите строку подключения и учетные данные в конфигурации приложения.</span><span class="sxs-lookup"><span data-stu-id="a0b51-275">Update the connection string and credentials to your app's configuration.</span></span>

<span data-ttu-id="a0b51-276">Пример</span><span class="sxs-lookup"><span data-stu-id="a0b51-276">Example:</span></span>

```csharp
public void ConfigureServices(IServiceCollection services)
{
    // Add identity types
    services.AddIdentity<ApplicationUser, ApplicationRole>()
        .AddDefaultTokenProviders();

    // Identity Services
    services.AddTransient<IUserStore<ApplicationUser>, CustomUserStore>();
    services.AddTransient<IRoleStore<ApplicationRole>, CustomRoleStore>();
    string connectionString = Configuration.GetConnectionString("DefaultConnection");
    services.AddTransient<SqlConnection>(e => new SqlConnection(connectionString));
    services.AddTransient<DapperUsersTable>();

    // additional configuration
}
```

## <a name="references"></a><span data-ttu-id="a0b51-277">Ссылки</span><span class="sxs-lookup"><span data-stu-id="a0b51-277">References</span></span>

* [<span data-ttu-id="a0b51-278">Пользовательские поставщики хранилища для удостоверения ASP.NET 4. x</span><span class="sxs-lookup"><span data-stu-id="a0b51-278">Custom Storage Providers for ASP.NET 4.x Identity</span></span>](/aspnet/identity/overview/extensibility/overview-of-custom-storage-providers-for-aspnet-identity)
* <span data-ttu-id="a0b51-279">[Удостоверение ASP.NET Core](https://github.com/aspnet/identity) &ndash; Этот репозиторий содержит ссылки на поставщики хранилищ, поддерживаемые сообществом.</span><span class="sxs-lookup"><span data-stu-id="a0b51-279">[ASP.NET Core Identity](https://github.com/aspnet/identity) &ndash; This repository includes links to community maintained store providers.</span></span>
