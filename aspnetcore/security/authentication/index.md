---
title: Общие сведения о проверке подлинности в ASP.NET Core
author: mjrousos
description: Узнайте, как работает проверка подлинности в ASP.NET Core.
ms.author: riande
ms.custom: mvc
ms.date: 03/03/2020
uid: security/authentication/index
ms.openlocfilehash: 24113fd4f090cf76746a7b077212fdab012f82c1
ms.sourcegitcommit: 9a129f5f3e31cc449742b164d5004894bfca90aa
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/06/2020
ms.locfileid: "78644362"
---
# <a name="overview-of-aspnet-core-authentication"></a>Общие сведения о проверке подлинности в ASP.NET Core

Автор: [Майк Роусос (Mike Rousos)](https://github.com/mjrousos)

Проверка подлинности — это процесс установления личности пользователя. [Авторизация](xref:security/authorization/introduction) — это процесс определения, есть ли у пользователя доступ к ресурсу. Проверка подлинности в ASP.NET Core выполняется через интерфейс `IAuthenticationService`, применяемый в специальном [ПО промежуточного слоя](xref:fundamentals/middleware/index). Служба проверки подлинности использует зарегистрированные обработчики для выполнения связанных с проверкой подлинности действий. Примеры таких действий:

* Проверка подлинности пользователя.
* Реагирование на ситуацию, когда не прошедший проверку подлинности пользователь пытается обратиться к ресурсу, доступ к которому ограничен.

Зарегистрированные обработчики проверки подлинности и их параметры конфигурации называются "схемами".

Схемы проверки подлинности задаются путем регистрации служб проверки подлинности в `Startup.ConfigureServices` следующими способами:

* После вызова `services.AddAuthentication` (например, `AddJwtBearer` или `AddCookie`) выполняется вызов метода расширения для конкретной схемы. Эти методы расширения используют [AuthenticationBuilder.AddScheme](xref:Microsoft.AspNetCore.Authentication.AuthenticationBuilder.AddScheme*) для регистрации схем с необходимыми параметрами.
* В более редких случаях выполняется вызов [AuthenticationBuilder.AddScheme](xref:Microsoft.AspNetCore.Authentication.AuthenticationBuilder.AddScheme*) напрямую.

Например, следующий код позволяет зарегистрировать службы и обработчики для схем проверки подлинности на основе файлов cookie и носителя JWT:

```csharp
services.AddAuthentication(JwtBearerDefaults.AuthenticationScheme)
    .AddJwtBearer(JwtBearerDefaults.AuthenticationScheme, options => Configuration.Bind("JwtSettings", options))
    .AddCookie(CookieAuthenticationDefaults.AuthenticationScheme, options => Configuration.Bind("CookieSettings", options));
```

В `AddAuthentication` параметр `JwtBearerDefaults.AuthenticationScheme` представляет собой имя схемы, применяемой по умолчанию, когда конкретная схема не запрашивается.

Если используется множество схем, в политиках (или атрибутах) авторизации можно [указать конкретные схемы](xref:security/authorization/limitingidentitybyscheme), применяемые для проверки подлинности пользователя. В приведенном выше примере можно специально задать использование схемы на основе файлов cookie, указав ее имя (по умолчанию — `CookieAuthenticationDefaults.AuthenticationScheme`, однако при вызове `AddCookie` можно указать другое).

В некоторых случаях `AddAuthentication` автоматически вызывается другими методами расширения. Например, при использовании [ASP.NET Core Identity](xref:security/authentication/identity) выполняется внутренний вызов `AddAuthentication`.

ПО промежуточного слоя для проверки подлинности добавляется в `Startup.Configure` путем вызова метода расширения <xref:Microsoft.AspNetCore.Builder.AuthAppBuilderExtensions.UseAuthentication*> в интерфейсе `IApplicationBuilder` приложения. Вызов `UseAuthentication` регистрирует ПО промежуточного слоя, использующее зарегистрированные ранее схемы проверки подлинности. Следует вызывать `UseAuthentication` перед вызовом любого ПО промежуточного слоя, требующего проверки подлинности пользователей. При использовании маршрутизации конечных точек метод `UseAuthentication` необходимо вызывать в следующем порядке:

* После `UseRouting`, чтобы были доступны сведения о маршрутизации, необходимые для принятия решений о проверке подлинности.
* До `UseEndpoints`, чтобы пользователи проходили проверку подлинности перед доступом к конечным точкам.

## <a name="authentication-concepts"></a>Концепции проверки подлинности

### <a name="authentication-scheme"></a>Схема проверки подлинности

Схема проверки подлинности — это имя, соответствующее следующим элементам:

* обработчик проверки подлинности;
* параметры для настройки конкретного экземпляра обработчика.

Схемы выполняют роль механизма, определяющего действия проверки подлинности, проверочного запроса и запрета для связанного обработчика. Например, политика авторизации может использовать имена схем для указания схемы или схем авторизации, которые должны использоваться для проверки подлинности пользователя. При настройке проверки подлинности обычно задается схема проверки подлинности по умолчанию. Она применяется, если ресурс не запрашивает конкретную схему. Также доступны следующие возможности:

* Можно указать разные схемы по умолчанию для действий проверки подлинности, проверочного запроса и запрета.
* Можно объединить несколько схем в одну, используя [схемы политик](xref:security/authentication/policyschemes).

### <a name="authentication-handler"></a>Обработчик проверки подлинности

Обработчик проверки подлинности:

* является типом, который реализует действия схемы;
* является производным от <xref:Microsoft.AspNetCore.Authentication.IAuthenticationHandler> или <xref:Microsoft.AspNetCore.Authentication.AuthenticationHandler`1>;
* служит главным образом для проверки подлинности пользователей.

В зависимости от конфигурации схемы проверки подлинности и контекста входящего запроса обработчики проверки подлинности:

* создают объекты <xref:Microsoft.AspNetCore.Authentication.AuthenticationTicket>, представляющие удостоверение пользователя, если проверка подлинности прошла успешно;
* возвращают "результат отсутствует" или "сбой", если проверка подлинности не пройдена;
* поддерживают методы для действий проверочного запроса или запрета при попытке пользователей получить доступ к ресурсам в следующих случаях:
  * отсутствуют права доступа (запрет);
  * не пройдена проверка подлинности (проверочный запрос).

### <a name="authenticate"></a>Authenticate

Действие проверки подлинности в схеме отвечает за получение удостоверения пользователя в зависимости от контекста запроса. Оно возвращает объект <xref:Microsoft.AspNetCore.Authentication.AuthenticateResult>, который указывает, выполнена ли проверка подлинности, и, если да, включает удостоверение пользователя в билете проверки подлинности. См. раздел <xref:Microsoft.AspNetCore.Authentication.AuthenticationHttpContextExtensions.AuthenticateAsync%2A>. Примеры проверки подлинности:

* Схема проверки подлинности на основе cookie получает удостоверение пользователя из файлов cookie.
* Схема на основе носителя JWT десериализирует и проверяет токен носителя JWT для получения удостоверения пользователя.

### <a name="challenge"></a>Задача

Проверочный запрос вызывается процессом авторизации, когда пользователь, не прошедший проверку подлинности, запрашивает доступ к конечной точке, требующей проверку. Запрос выдается, например, если анонимный пользователь обращается к ресурсу с ограниченным доступом или щелкает какую-то ссылку для входа. Процесс авторизации выдает запрос с использованием указанных схем проверки подлинности. Если схемы не заданы, применяется схема по умолчанию. См. раздел <xref:Microsoft.AspNetCore.Authentication.AuthenticationHttpContextExtensions.ChallengeAsync%2A>. Примеры проверочных запросов:

* Схема проверки подлинности на основе файлов cookie перенаправляет пользователя на страницу входа.
* Схема на основе носителя JWT возвращает результат 401 с заголовком `www-authenticate: bearer`.

Действие проверочного запроса должно сообщать пользователю, какой механизм проверки подлинности необходим для доступа к запрошенному ресурсу.

### <a name="forbid"></a>Запрет

Действие запрета в схеме проверки подлинности вызывается процессом авторизации, когда прошедший проверку подлинности пользователь пытается обратиться к ресурсу, к которому у него нет прав доступа. См. раздел <xref:Microsoft.AspNetCore.Authentication.AuthenticationHttpContextExtensions.ForbidAsync%2A>. Примеры запрета проверки подлинности:
* Схема проверки подлинности на основе файлов cookie перенаправляет пользователя на страницу с сообщением об отказе в доступе.
* Схема на основе носителя JWT возвращает результат 403.
* Настраиваемая схема проверки подлинности перенаправляет пользователя на страницу, где он может запросить доступ к ресурсу.

Действие запрета может сообщить пользователю следующее:

* Проверка подлинности пройдена.
* Доступ к запрошенному ресурсу не разрешен.

Сведения о различиях между действиями проверочного запроса и запрета см. по следующим ссылкам:

* [Проверочный запрос и запрет с помощью обработчика ресурсов операций](xref:security/authorization/resourcebased#challenge-and-forbid-with-an-operational-resource-handler).
* [Различия между проверочным запросом и запретом](xref:security/authorization/secure-data#challenge).

## <a name="additional-resources"></a>Дополнительные ресурсы

* <xref:security/authorization/limitingidentitybyscheme>
* <xref:security/authentication/policyschemes>
* <xref:security/authorization/secure-data>
