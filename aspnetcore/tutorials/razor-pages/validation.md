---
title: "Добавление проверки"
author: rick-anderson
description: "В этой статье объясняется, как добавлять проверки на страницу Razor."
keywords: "ASP.NET Core,проверка,DataAnnotations,Razor,страницы Razor"
ms.author: riande
manager: wpickett
ms.date: 08/07/2017
ms.topic: get-started-article
ms.technology: aspnet
ms.prod: aspnet-core
uid: tutorials/razor-pages/validation
ms.openlocfilehash: bd794ae2217c2a56f36cd46c2f12f1c80f6b4f2b
ms.sourcegitcommit: fe880bf4ed1c8116071c0e47c0babf3623b7f44a
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/21/2017
---
# <a name="adding-validation-to-a-razor-page"></a>Добавление проверки на страницу Razor

Автор: [Рик Андерсон](https://twitter.com/RickAndMSFT) (Rick Anderson)

В этом разделе к модели `Movie` добавляется логика проверки. Правила проверки применяются каждый раз, когда пользователь создает или редактирует фильм.

## <a name="validation"></a>Проверка

Ключевой принцип разработки программного обеспечения называется [DRY](https://wikipedia.org/wiki/Don%27t_repeat_yourself) (от английского "**D**on't **R**epeat **Y**ourself" — не повторяйся). При разработке страниц Razor Pages рекомендуется задавать любые функциональные возможности лишь один раз и затем при необходимости отражать их в рамках всего приложения. Этот принцип направлен на сокращение объема кода в приложении. Следуя ему, вы снижаете вероятность возникновения ошибки в коде и упрощаете его тестирование и поддержку.

Ярким примером применения принципа "Не повторяйся" является поддержка проверки, реализуемая на страницах Razor и на платформе Entity Framework. Правила проверки декларативно определяются в одном месте (в классе модели) и затем применяются в рамках всего приложения.

### <a name="adding-validation-rules-to-the-movie-model"></a>Добавление правил проверки к модели фильма

Откройте файл *Movie.cs*. Класс [DataAnnotations](https://docs.microsoft.com/aspnet/mvc/overview/older-versions/mvc-music-store/mvc-music-store-part-6) предоставляет набор встроенных атрибутов проверки, которые декларативно применяются к классу или свойству. Кроме того, DataAnnotations содержит атрибуты форматирования (такие как `DataType`), которые обеспечивают форматирование и не предназначены для проверки.

Обновите класс `Movie`, чтобы использовать преимущества атрибутов проверки `Required`, `StringLength`, `RegularExpression` и `Range`.

[!code-csharp[Main](../../tutorials/first-mvc-app/start-mvc//sample/MvcMovie/Models/MovieDateRatingDA.cs?name=snippet1)]

Атрибуты проверки определяют поведение, которое применяется к свойствам модели.

* Атрибуты `Required` и `MinimumLength` означают, что свойство должно иметь значение. Но пользователь может ввести пробел, чтобы соблюсти ограничение проверки для типа, допускающего значение null. [Типы значений](https://docs.microsoft.com/dotnet/csharp/language-reference/keywords/value-types), не допускающие значение null (например, `decimal`, `int`, `float` и `DateTime`), являются обязательными и не требуют атрибута `Required`.
* Атрибут `RegularExpression` ограничивает символы, которые может ввести пользователь. В приведенном выше коде в полях `Genre` и `Rating` можно использовать только буквы (пробелы, числа и специальные символы не допускаются).
* Атрибут `Range` ограничивает диапазон значений.
* Атрибут `StringLength` задает максимальную и при необходимости минимальную длину строки. 

Наличие правил проверки, которые автоматически применяются ASP.NET Core, помогает повысить степень надежности приложения. Автоматическая проверка моделей помогает защитить приложение, поскольку вам не приходится беспокоиться о самостоятельной проверке добавляемого кода.

### <a name="validation-error-ui-in-razor-pages"></a>Пользовательский интерфейс проверки ошибок на страницах Razor

Запустите приложение и перейдите в раздел "Pages/Movies" (Страницы/фильмы).

Щелкните ссылку **Create New** (Создать). Введите в форму какие-либо недопустимые значения. Если функция проверки jQuery на стороне клиента обнаруживает ошибку, сведения о ней отображаются в соответствующем сообщении.

![Форма просмотра фильма с несколькими ошибками проверки jQuery на стороне клиента](validation/_static/val.png)

> [!NOTE]
> В поле `Price` нельзя вводить десятичные точки или запятые. Чтобы обеспечить поддержку [проверки jQuery](https://jqueryvalidation.org/) для других языков, кроме английского, используйте вместо десятичной точки запятую (","), а для отображения данных в форматах для других языков, кроме английского, выполните действия, необходимые для глобализации вашего приложения. Дополнительные сведения см. в разделе [Дополнительные ресурсы](#additional-resources). А пока вводите целые числа, такие как 10.

Обратите внимание, что для каждого поля, содержащего недопустимое значение, в форме автоматически отображается сообщение об ошибке проверки. Эти ошибки применяются как на стороне клиента (с помощью JavaScript и jQuery), так и на стороне сервера (если пользователь отключает JavaScript).

Основным преимуществом является то, что на страницах создания или редактирования **не требуется** изменять код. После применения класса DataAnnotations к модели активируется пользовательский интерфейс проверки. На страницах Razor, создаваемых в рамках этого руководства, автоматически применяются правила проверки (для этого к свойствам класса модели `Movie` применяются атрибуты). При проверке страницы редактирования применяются те же правила.

Данные формы передаются на сервер только после того, как будут устранены любые ошибки на стороне клиента. Чтобы убедиться, что данные формы не отправляются, используйте любой из следующих способов:

* Поместите точку останова в метод `OnPostAsync`. Отправьте форму с помощью команды **Create** (Создать) или **Save** (Сохранить). Точка останова не достигается ни при каких обстоятельствах.
* Используйте [инструмент Fiddler](http://www.telerik.com/fiddler).
* Проследите сетевой трафик с помощью инструментов разработчика для браузера.

### <a name="server-side-validation"></a>Проверка на стороне сервера

Если в браузере отключен JavaScript, форма с ошибками отправляется на сервер.

Реализация проверки на стороне сервера:

* Отключите JavaScript в браузере. Если сделать это не удается, попробуйте использовать другой браузер.
* Поместите точку останова в метод `OnPostAsync` страниц создания или редактирования.
* Отправьте форму с ошибками проверки.
* Проверка недопустимого состояния модели:

  ```csharp
   if (!ModelState.IsValid)
   {
      return Page();
   }
  ```

В следующем коде демонстрируется часть страницы *Create.cshtml*, сформированной ранее в рамках этого руководства. Она используется на страницах создания и редактирования для отображения исходной формы и повторного вывода формы в случае ошибки.

[!code-cshtml[Main](razor-pages-start/sample/RazorPagesMovie/Pages/Movies/Create.cshtml?range=14-20)]

[Вспомогательная функция тега Input](xref:mvc/views/working-with-forms) использует атрибуты [DataAnnotations](https://docs.microsoft.com/aspnet/mvc/overview/older-versions/mvc-music-store/mvc-music-store-part-6) и создает HTML-атрибуты, необходимые для проверки jQuery на стороне клиента. [Вспомогательная функция тега Validation](xref:mvc/views/working-with-forms#the-validation-tag-helpers) отображает ошибки проверки. Дополнительные сведения см. в разделе [Проверка](xref:mvc/models/validation).

На страницах создания и редактирования не определены правила проверки. Правила проверки и строки ошибок указываются только в классе `Movie`. Они автоматически применяются к страницам Razor, которые редактируют модель `Movie`.

Любые необходимые изменения логики проверки осуществляются исключительно в модели. Проверка применяется согласованно на уровне всего приложения, для чего логика проверки определяется в одном месте. Такой подход позволяет максимально оптимизировать код и упростить его поддержку и обновление.

## <a name="using-datatype-attributes"></a>Использование атрибутов DataType

Проверьте класс `Movie`. В пространстве имен `System.ComponentModel.DataAnnotations` в дополнение к набору встроенных атрибутов проверки предоставляются атрибуты форматирования. Атрибут `DataType` применяется к свойствам `ReleaseDate` и `Price`.

[!code-csharp[Main](razor-pages-start/sample/RazorPagesMovie/Models/MovieDateRatingDA.cs?highlight=2,6&name=snippet2)]

Атрибуты `DataType` предоставляют модулю просмотра только рекомендации по форматированию данных, а также другие атрибуты, например `<a>` для URL-адресов и `<a href="mailto:EmailAddress.com">` для электронной почты. Используйте атрибут `RegularExpression` для проверки формата данных. Атрибут `DataType` позволяет указать тип данных с более точным определением относительно встроенного типа базы данных. Атрибуты `DataType` не предназначены для проверки. В том же приложении отображается только дата (без времени).

В перечислении `DataType` представлено множество типов данных, таких как Date, Time, PhoneNumber, Currency, EmailAddress и других. Атрибут `DataType` также обеспечивает автоматическое предоставление функций для определенных типов в приложении. Например, можно создавать ссылку `mailto:` для `DataType.EmailAddress`. Для `DataType.Date` в браузерах с поддержкой HTML5 можно предоставить селектор даты. Атрибут `DataType` создает атрибуты HTML 5 `data-`, которые используются браузерами с поддержкой HTML 5. Атрибуты `DataType` **не предназначены** для проверки.

`DataType.Date` не задает формат отображаемой даты. По умолчанию поле данных отображается с использованием форматов, установленных в параметрах `CultureInfo` сервера.

С помощью атрибута `DisplayFormat` можно явно указать формат даты:

```csharp
[DisplayFormat(DataFormatString = "{0:yyyy-MM-dd}", ApplyFormatInEditMode = true)]
public DateTime ReleaseDate { get; set; }
```

Параметр `ApplyFormatInEditMode` указывает, что формат должен применяться при отображении значения для редактирования. Для некоторых полей такое поведение нежелательно. Например, в полях валюты в пользовательском интерфейсе редактирования использовать символ денежной единицы, как правило, не требуется.

Атрибут `DisplayFormat` может использоваться отдельно, однако чаще всего его рекомендуется применять вместе с атрибутом `DataType`. Атрибут `DataType` передает семантику данных (в отличие от способа их вывода на экран) и дает следующие преимущества по сравнению с атрибутом DisplayFormat:

* Поддержка функций HTML5 в браузере (отображение элемента управления календарем, соответствующего языковому стандарту символа валюты, ссылок электронной почты и т. д.)
* По умолчанию формат отображения данных в браузере определяется в соответствии с установленным языковым стандартом.
* Атрибут `DataType` обеспечивает поддержку платформы ASP.NET Core для выбора соответствующего шаблона поля, применяемого при отображении данных. При отдельном использовании атрибут `DisplayFormat` базируется на строковом шаблоне.

Примечание. Проверка jQuery не работает с атрибутами `Range` и `DateTime`. Например, следующий код всегда приводит к возникновению ошибки проверки на стороне клиента, даже если дата попадает в указанный диапазон:

```csharp
[Range(typeof(DateTime), "1/1/1966", "1/1/2020")]
   ```

Как правило, не рекомендуется компилировать модели с фиксированными датами, поэтому использовать атрибуты `Range` и `DateTime` следует крайне осторожно.

В следующем коде демонстрируется объединение атрибутов в одной строке:

[!code-csharp[Main](razor-pages-start/sample/RazorPagesMovie/Models/MovieDateRatingDAmult.cs?name=snippet1)]

Дополнительные операции EF Core с Razor Pages см. в статье [Начало работы с Razor Pages и EF Core](xref:data/ef-rp/intro).

### <a name="publish-to-azure"></a>Публикация в Azure

Дополнительные сведения о публикации этого приложения в Azure см. в руководстве по [публикации веб-приложения ASP.NET Core в службе приложений Azure с помощью Visual Studio](xref:tutorials/publish-to-azure-webapp-using-vs).

## <a name="additional-resources"></a>Дополнительные ресурсы

* [Работа с формами](xref:mvc/views/working-with-forms)
* [Глобализация и локализация](xref:fundamentals/localization)
* [Общие сведения о вспомогательных функциях тегов](xref:mvc/views/tag-helpers/intro)
* [Создание вспомогательных функций тегов](xref:mvc/views/tag-helpers/authoring)

>[!div class="step-by-step"]
[Предыдущая тема. Добавление нового поля](xref:tutorials/razor-pages/new-field)
[Следующая тема. Отправка файлов](xref:tutorials/razor-pages/uploading-files)
