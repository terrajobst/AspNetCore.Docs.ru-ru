---
title: ASP.NET Core SignalR рабочего размещения и масштабирования
author: bradygaster
description: Узнайте, как избежать проблем с производительностью и масштабированием в приложениях, использующих ASP.NET Core SignalR.
monikerRange: '>= aspnetcore-2.1'
ms.author: bradyg
ms.custom: mvc
ms.date: 01/17/2020
no-loc:
- SignalR
uid: signalr/scale
ms.openlocfilehash: 260e2f0c16288fec2e0a694d070f357529782d8d
ms.sourcegitcommit: 6645435fc8f5092fc7e923742e85592b56e37ada
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/19/2020
ms.locfileid: "77447338"
---
# <a name="aspnet-core-signalr-hosting-and-scaling"></a>ASP.NET Coreное размещение и масштабирование SignalR

[Эндрю Стантон-медперсонала](https://twitter.com/anurse), [Брейди Гастер](https://twitter.com/bradygaster)и [Tom Dykstra)](https://github.com/tdykstra),

В этой статье описываются вопросы размещения и масштабирования для приложений с высоким уровнем трафика, использующих ASP.NET Core SignalR.

## <a name="sticky-sessions"></a>Закрепленные сеансы

SignalR требует, чтобы все HTTP-запросы для определенного соединения обрабатывались одним и тем же процессом сервера. Когда SignalR работает на ферме серверов (несколько серверов), необходимо использовать "прикрепленные сеансы". «Прикрепленные сеансы» также называют сходством сеансов некоторыми подсистемами балансировки нагрузки. Служба приложений Azure использует [маршрутизацию запросов приложений](https://docs.microsoft.com/iis/extensions/planning-for-arr/application-request-routing-version-2-overview) (ARR) для маршрутизации запросов. Включение параметра "Настройка сходства" в службе приложений Azure включит "закрепленные сеансы". Существуют следующие ситуации, в которых не требуется закрепить сеансы.

1. При размещении на одном сервере в одном процессе.
1. При использовании службы Azure SignalR.
1. Если все клиенты настроены на использование **только** WebSockets, **а** [параметр скипнеготиатион](xref:signalr/configuration#configure-additional-options) включен в конфигурации клиента.

Во всех остальных случаях (включая использование объединительной платы Redis) серверная среда должна быть настроена для работы с закрепленными сеансами.

Рекомендации по настройке службы приложений Azure для SignalR см. в разделе <xref:signalr/publish-to-azure-web-app>.

## <a name="tcp-connection-resources"></a>Ресурсы TCP-подключения

Количество одновременных TCP-подключений, которое может поддерживаться веб-сервером, ограничено. Стандартные клиенты HTTP используют *временные* подключения. Эти подключения могут быть закрыты, когда клиент переходит в состояние простоя и снова открывается позже. С другой стороны, подключение SignalR является *постоянным*. Подключения SignalR остаются открытыми, даже когда клиент переходит в состояние бездействия. В приложении с большим трафиком, которое обслуживает много клиентов, эти постоянные подключения могут привести к тому, что серверы достигли максимального числа подключений.

Постоянные подключения также потребляют некоторую дополнительную память для наблюдения за каждым подключением.

Интенсивное использование ресурсов, связанных с подключением, с помощью SignalR может повлиять на другие веб-приложения, размещенные на том же сервере. Когда SignalR открывается и содержит последние доступные подключения TCP, другие веб-приложения на том же сервере также не имеют доступных подключений.

Если на сервере не хватает подключений, вы увидите случайные ошибки сокета и ошибки сброса соединения. Например:

```
An attempt was made to access a socket in a way forbidden by its access permissions...
```

Чтобы предотвратить возникновение ошибок в других веб-приложениях с помощью ресурсов SignalR, запустите SignalR на разных серверах, а не на других веб-приложениях.

Чтобы предотвратить использование ресурсов SignalR в приложении SignalR, необходимо выполнить горизонтальное масштабирование, чтобы ограничить количество подключений, которые должны быть обработаны сервером.

## <a name="scale-out"></a>Масштабирование

Приложение, использующее SignalR, должно вести отслеживание всех его подключений, что создает проблемы для фермы серверов. Добавьте сервер, и он получает новые подключения, о которых не известны другие серверы. Например, SignalR на каждом сервере на следующей схеме не знает о соединениях на других серверах. Когда SignalR на одном из серверов хочет отправить сообщение всем клиентам, оно переходит только к клиентам, подключенным к этому серверу.

![Масштабирование SignalR без объединительной платы](scale/_static/scale-no-backplane.png)

Для решения этой проблемы можно указать [службу Azure SignalR](#azure-signalr-service) и [Redis объединительную плату](#redis-backplane).

## <a name="azure-signalr-service"></a>Служба SignalR Azure

Служба Azure SignalR — это прокси-сервер, а не Объединительная плата. Каждый раз, когда клиент инициирует подключение к серверу, клиент перенаправляется для подключения к службе. Этот процесс показан на следующей схеме:

![Установка подключения к службе SignalR Azure](scale/_static/azure-signalr-service-one-connection.png)

В результате служба управляет всеми клиентскими подключениями, в то время как каждому серверу требуется лишь небольшое постоянное число подключений к службе, как показано на следующей схеме:

![Клиенты, подключенные к службе, серверы, подключенные к службе](scale/_static/azure-signalr-service-multiple-connections.png)

Этот подход к горизонтальному масштабированию имеет несколько преимуществ по сравнению с альтернативой объединительной платы Redis:

* Прикрепленные сеансы, также известные как [сходство клиентов](/iis/extensions/configuring-application-request-routing-arr/http-load-balancing-using-application-request-routing#step-3---configure-client-affinity), не являются обязательными, так как клиенты сразу же перенаправляются в службу Azure SignalR при подключении.
* Приложение SignalR может масштабироваться в зависимости от числа отправленных сообщений, а служба Azure SignalR автоматически масштабируется для обработки любого числа подключений. Например, могут быть тысячи клиентов, но если отправлено всего несколько сообщений в секунду, то приложению SignalR не потребуется выполнять масштабирование на нескольких серверах только для самостоятельной обработки подключений.
* Приложение SignalR не будет использовать значительно больше ресурсов для подключения, чем веб-приложение без SignalR.

По этим причинам мы рекомендуем использовать службу Azure SignalR для всех ASP.NET Core приложений SignalR, размещенных в Azure, включая службу приложений, виртуальные машины и контейнеры.

Дополнительные сведения см. в [документации по службе Azure SignalR](/azure/azure-signalr/signalr-overview).

## <a name="redis-backplane"></a>Канал обмена Redis

[Redis](https://redis.io/) — это хранилище "ключ — значение" в памяти, которое поддерживает систему обмена сообщениями с моделью публикации и подписки. Для пересылки сообщений на другие серверы в объединительной плате Redis SignalR используется функция Pub/Re-in. Когда клиент устанавливает соединение, сведения о соединении передаются в объединительную плату. Когда сервер хочет отправить сообщение всем клиентам, он отправляется в объединительную плату. Объединительная плата знает все подключенные клиенты и серверы, на которых они находятся. Он отправляет сообщение всем клиентам через соответствующие серверы. Этот процесс показан на следующей схеме:

![Redis Объединительная часть, сообщение, отправленное с одного сервера на все клиенты](scale/_static/redis-backplane.png)

Объединительная плата Redis — это рекомендуемый подход к горизонтальному масштабированию для приложений, размещенных в собственной инфраструктуре. Если между центром обработки данных и центром обработки данных Azure возникает значительная задержка подключения, служба Azure SignalR может оказаться непрактичной для локальных приложений с низкой задержкой или требованиями высокой пропускной способности.

Преимущества службы Azure SignalR, упомянутые ранее, являются недостатками для объединительной платы Redis:

* Прикрепленные сеансы, также известные как [сходство клиентов](/iis/extensions/configuring-application-request-routing-arr/http-load-balancing-using-application-request-routing#step-3---configure-client-affinity), являются обязательными, за исключением случаев, когда выполняются **оба** следующих условия.
  * Все клиенты настроены для использования **только** WebSockets.
  * [Параметр скипнеготиатион](xref:signalr/configuration#configure-additional-options) включен в конфигурации клиента. 
   После инициации подключения на сервере соединение должно остаться на этом сервере.
* SignalR приложение должно масштабироваться на основе числа клиентов, даже если отправляется несколько сообщений.
* Приложение SignalR использует значительно больше ресурсов для подключения, чем веб-приложение без SignalR.

## <a name="iis-limitations-on-windows-client-os"></a>Ограничения IIS в клиентской ОС Windows

Windows 10 и Windows 8. x являются клиентскими операционными системами. Службы IIS в клиентских операционных системах имеют ограничение в 10 одновременных подключений. подключения SignalR:

* Временное и часто переустановленное.
* **Не** удаляется сразу, когда больше не используется.

Предыдущие условия, вероятно, пристигают 10 ограничений на подключение к клиентской ОС. При использовании клиентской ОС для разработки рекомендуется:

* Избегайте IIS.
* Используйте Kestrel или IIS Express в качестве целевых объектов развертывания.

## <a name="linux-with-nginx"></a>Linux с Nginx

Для SignalR WebSockets в качестве заголовков прокси-сервера и `Upgrade` укажите следующие `Connection`:

```nginx
proxy_set_header Upgrade $http_upgrade;
proxy_set_header Connection $connection_upgrade;
```

Дополнительные сведения см. в статье об [использовании NGINX в качестве прокси-сервера WebSocket](https://www.nginx.com/blog/websocket-nginx/).

## <a name="third-party-opno-locsignalr-backplane-providers"></a>Поставщики объединительной платы SignalR сторонних поставщиков

* [NCache](https://www.alachisoft.com/ncache/asp-net-core-signalr.html)
* [Orleans](https://github.com/OrleansContrib/SignalR.Orleans)

## <a name="next-steps"></a>Следующие шаги

Дополнительные сведения см. в следующих источниках.

* [Документация по службе SignalR Azure](/azure/azure-signalr/signalr-overview)
* [Настройка объединительной платы Redis](xref:signalr/redis-backplane)
