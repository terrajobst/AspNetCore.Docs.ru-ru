---
title: Устранение неполадок ASP.NET Core в службе приложений Azure и службах IIS
author: guardrex
description: Узнайте, как диагностировать проблемы со службами приложений Azure и развертываниями службы IIS (IIS) ASP.NET Core приложений.
monikerRange: '>= aspnetcore-2.1'
ms.author: riande
ms.custom: mvc
ms.date: 07/17/2019
uid: test/troubleshoot-azure-iis
ms.openlocfilehash: 46d4a11c594844e059fa8555255d7321f7b48631
ms.sourcegitcommit: b40613c603d6f0cc71f3232c16df61550907f550
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/18/2019
ms.locfileid: "68308797"
---
# <a name="troubleshoot-aspnet-core-on-azure-app-service-and-iis"></a>Устранение неполадок ASP.NET Core в службе приложений Azure и службах IIS

[Люк ЛаСаМ](https://github.com/guardrex) и [Джастин коталик](https://github.com/jkotalik)

В этой статье содержатся сведения об общих ошибках запуска приложений и инструкции по диагностике ошибок при развертывании приложения в службе приложений Azure или службах IIS.

[Ошибки запуска приложений](#app-startup-errors)  
Описание распространенных сценариев кода состояния HTTP для запуска.

[Устранение неполадок в службе приложений Azure](#troubleshoot-on-azure-app-service)  
Рекомендации по устранению неполадок для приложений, развернутых в службе приложений Azure.

[Устранение неполадок в IIS](#troubleshoot-on-iis)  
Рекомендации по устранению неполадок приложений, развернутых в службах IIS или запущенных на IIS Express локально. Руководство относится к развертываниям Windows Server и Windows Desktop.

[Очистить кэши пакетов](#clear-package-caches)  
Объясняет, что делать, когда несогласованные пакеты нарушают работу приложения при выполнении основных обновлений или изменении версий пакета.

[Дополнительные ресурсы](#additional-resources)  
Список дополнительных разделов по устранению неполадок.

## <a name="app-startup-errors"></a>Ошибки при запуске приложения

::: moniker range=">= aspnetcore-2.2"

В Visual Studio проект ASP.NET Core по умолчанию использует размещение в [IIS Express](/iis/extensions/introduction-to-iis-express/iis-express-overview) на период отладки. Ошибка в *502,5-процессе* или *500,30-запуск* , возникающая при локальной отладке для диагностики с помощью инструкции в этом разделе.

::: moniker-end

::: moniker range="< aspnetcore-2.2"

В Visual Studio проект ASP.NET Core по умолчанию использует размещение в [IIS Express](/iis/extensions/introduction-to-iis-express/iis-express-overview) на период отладки. *Ошибка процесса 502,5* , возникающая при локальной отладке, может быть выявлена с помощью Совета в этом разделе.

::: moniker-end

### <a name="500-internal-server-error"></a>500 Internal Server Error (внутренняя ошибка сервера)

Приложение запускается, но ошибка не позволяет серверу выполнить запрос.

Эта ошибка возникает в коде приложения при запуске или при создании ответа. Ответ может не иметь содержимого или ответ в браузере может выглядеть как *500 — внутренняя ошибка сервера*. Как правило, в журнале событий приложения указывается, что приложение запускается в обычном режиме. Сервер действует правильно. Приложение запустилось, но оно не может генерировать действительный ответ. Запустите приложение из командной строки на сервере или включите журнал ASP.NET Core модуля stdout, чтобы устранить проблему.

::: moniker range="= aspnetcore-2.2"

### <a name="5000-in-process-handler-load-failure"></a>500.0 In-Process Handler Load Failure (ошибка загрузки внутрипроцессного обработчика)

Рабочий процесс завершается ошибкой. Приложение не запускается.

[Модулю ASP.NET Core](xref:host-and-deploy/aspnet-core-module) не удается найти среду CLR .NET Core и найти внутрипроцессный обработчик запросов (*aspnetcorev2_inprocess. dll*). Проверьте следующие моменты:

* приложение предназначено для пакета NuGet [Microsoft.AspNetCore.Server.IIS](https://www.nuget.org/packages/Microsoft.AspNetCore.Server.IIS) или [метапакета Microsoft.AspNetCore.App](xref:fundamentals/metapackage-app);
* версия общей платформы ASP.NET Core, для которой предназначено приложение, установлена на целевом компьютере.

### <a name="5000-out-of-process-handler-load-failure"></a>500.0 Out-Of-Process Handler Load Failure (ошибка загрузки внепроцессного обработчика)

Рабочий процесс завершается ошибкой. Приложение не запускается.

[Модулю ASP.NET Core](xref:host-and-deploy/aspnet-core-module) не удается найти обработчик запросов внутрипроцессного размещения. Убедитесь, что *aspnetcorev2_outofprocess.dll* находится во вложенной папке рядом с *aspnetcorev2.dll*.

::: moniker-end

::: moniker range=">= aspnetcore-3.0"

### <a name="5000-in-process-handler-load-failure"></a>500.0 In-Process Handler Load Failure (ошибка загрузки внутрипроцессного обработчика)

Рабочий процесс завершается ошибкой. Приложение не запускается.

При загрузке компонентов [модуля ASP.NET Core](xref:host-and-deploy/aspnet-core-module) произошла неизвестная ошибка. Выполните одно из указанных ниже действий.

* Обратитесь в [службу поддержки Майкрософт](https://support.microsoft.com/oas/default.aspx?prid=15832) (выберите **Средства разработчика**, а затем — **ASP.NET Core**).
* Задайте вопрос на сайте Stack Overflow.
* Сообщите о проблеме в нашем [репозитории GitHub](https://github.com/aspnet/AspNetCore).

### <a name="50030-in-process-startup-failure"></a>500.30 In-Process Startup Failure (ошибка внутрипроцессного запуска)

Рабочий процесс завершается ошибкой. Приложение не запускается.

[Модуль ASP.NET Core](xref:host-and-deploy/aspnet-core-module) пытается запустить среду CLR .NET Core в процессе, но не запускается. Причину сбоя запуска процесса обычно можно определить на основе записей в журнале событий приложений и в журнале stdout модуля ASP.NET Core.

Распространенной причиной сбоя является неправильная настройка приложения с выбором отсутствующей версии общей платформы ASP.NET Core. Проверьте, какие версии общей платформы ASP.NET Core установлены на целевом компьютере.

### <a name="50031-ancm-failed-to-find-native-dependencies"></a>500.31 ANCM Failed to Find Native Dependencies (ANCM не удалось найти собственные зависимости)

Рабочий процесс завершается ошибкой. Приложение не запускается.

[Модуль ASP.NET Core](xref:host-and-deploy/aspnet-core-module) пытается запустить среду выполнения .NET Core в процессе, но не запускается. Наиболее распространенная причина этой ошибки в том, что среда выполнения `Microsoft.NETCore.App` или `Microsoft.AspNetCore.App` не установлена. Если целевой платформой развернутого приложения является ASP.NET Core 3.0, но эта версия отсутствует на компьютере, происходит данная ошибка. Пример сообщения об ошибке:

```
The specified framework 'Microsoft.NETCore.App', version '3.0.0' was not found.
  - The following frameworks were found:
      2.2.1 at [C:\Program Files\dotnet\x64\shared\Microsoft.NETCore.App]
      3.0.0-preview5-27626-15 at [C:\Program Files\dotnet\x64\shared\Microsoft.NETCore.App]
      3.0.0-preview6-27713-13 at [C:\Program Files\dotnet\x64\shared\Microsoft.NETCore.App]
      3.0.0-preview6-27714-15 at [C:\Program Files\dotnet\x64\shared\Microsoft.NETCore.App]
      3.0.0-preview6-27723-08 at [C:\Program Files\dotnet\x64\shared\Microsoft.NETCore.App]
```

В сообщении об ошибке перечислены все установленные версии .NET Core и указывается версия, которая требуется приложению. Чтобы устранить эту ошибку, выполните одно из указанных ниже действий.

* Установите соответствующую версию .NET Core на компьютере.
* Измените целевую версию .NET Core приложения на версию, имеющуюся на компьютере.
* Опубликуйте приложение как [автономное развертывание](/dotnet/core/deploying/#self-contained-deployments-scd).

При запуске в среде разработки (переменная среды `ASPNETCORE_ENVIRONMENT` имеет значение `Development`) ошибка записывается в ответ HTTP. Причина сбоя запуска процесса также находится в журнале событий приложений.

### <a name="50032-ancm-failed-to-load-dll"></a>500.32 ANCM Failed to Load dll (ANCM не удалось загрузить библиотеку DLL)

Рабочий процесс завершается ошибкой. Приложение не запускается.

Наиболее распространенная причина этой ошибки в том, что приложение опубликовано для несовместимой архитектуры процессора. Если рабочий процесс выполняется как 32-разрядное приложение, но приложение было опубликовано для 64-разрядной архитектуры, происходит эта ошибка.

Чтобы устранить эту ошибку, выполните одно из указанных ниже действий.

* Повторно опубликуйте приложение для той же архитектуры процессора, для которой предназначен рабочий процесс.
* Опубликуйте приложение как [зависящее от платформы развертывание](/dotnet/core/deploying/#framework-dependent-executables-fde).

### <a name="50033-ancm-request-handler-load-failure"></a>500.33 ANCM Request Handler Load Failure (Ошибка загрузки обработчика запросов ANCM)

Рабочий процесс завершается ошибкой. Приложение не запускается.

Приложение не ссылается на платформу `Microsoft.AspNetCore.App`. Только приложения, предназначенные `Microsoft.AspNetCore.App` для платформы, могут размещаться в [модуле ASP.NET Core](xref:host-and-deploy/aspnet-core-module).

Для устранения этой ошибки убедитесь в том, что приложение предназначено для платформы `Microsoft.AspNetCore.App`. В файле `.runtimeconfig.json` проверьте, является ли эта платформа целевой для приложения.

### <a name="50034-ancm-mixed-hosting-models-not-supported"></a>500.34 ANCM Mixed Hosting Models Not Supported (Смешанные модели размещения ANCM не поддерживаются)

В одном рабочем процессе не могут выполняться одновременно внутрипроцессное приложение и внепроцессное приложение.

Для устранения этой ошибки запускайте приложения в отдельных пулах приложений IIS.

### <a name="50035-ancm-multiple-in-process-applications-in-same-process"></a>500.35 ANCM Multiple In-Process Applications in same Process (Несколько внутрипроцессных приложений ANCM в одном процессе)

В одном рабочем процессе не могут выполняться одновременно внутрипроцессное приложение и внепроцессное приложение.

Для устранения этой ошибки запускайте приложения в отдельных пулах приложений IIS.

### <a name="50036-ancm-out-of-process-handler-load-failure"></a>500.36 ANCM Out-Of-Process Handler Load Failure (Ошибка загрузки внепроцессного обработчика ANCM)

Рядом с файлом *aspnetcorev2.dll* нет внепроцессного обработчика запросов *aspnetcorev2_outofprocess.dll*. Это указывает на поврежденную установку [модуля ASP.NET Core](xref:host-and-deploy/aspnet-core-module).

Для устранения этой ошибки восстановите установку [пакета размещения .NET Core](xref:host-and-deploy/iis/index#install-the-net-core-hosting-bundle) (для служб IIS) или Visual Studio (для IIS Express).

### <a name="50037-ancm-failed-to-start-within-startup-time-limit"></a>500.37 ANCM Failed to Start Within Startup Time Limit (Модуль ANCM не запустился в течение предельного времени запуска)

Модуль ANCM не запустился в течение заданного предельного времени запуска. По умолчанию время ожидания составляет 120 секунд.

Эта ошибка может произойти, если на одном компьютере запускается много приложений. Обратите внимание на пики использования ЦП и памяти на сервере во время запуска. Возможно, потребуется регулировать процесс запуска нескольких приложений.

::: moniker-end

### <a name="5025-process-failure"></a>502.5 Process Failure (ошибка процесса)

Рабочий процесс завершается ошибкой. Приложение не запускается.

[Модуль ASP.NET Core](xref:host-and-deploy/aspnet-core-module) пытается запустить рабочий процесс, но он не запускается. Причину сбоя запуска процесса обычно можно определить на основе записей в журнале событий приложений и в журнале stdout модуля ASP.NET Core.

Распространенной причиной сбоя является неправильная настройка приложения с выбором отсутствующей версии общей платформы ASP.NET Core. Проверьте, какие версии общей платформы ASP.NET Core установлены на целевом компьютере. *Общая платформа* — это набор сборок (*DLLl*-файлы), которые установлены на компьютере и на которые ссылается метапакет, например `Microsoft.AspNetCore.App`. В ссылках метапакета может быть указана минимальная требуемая версия. Дополнительную информацию см. в этой публикации об [общей платформе](https://natemcmaster.com/blog/2018/08/29/netcore-primitives-2/).

Когда ошибки в конфигурации размещения или приложения приводят к сбою рабочего процесса, возвращается страница ошибки *502.5 — ошибка процесса*.

### <a name="failed-to-start-application-errorcode-0x800700c1"></a>Не удалось запустить приложение (код ошибки "0x800700c1")

```
EventID: 1010
Source: IIS AspNetCore Module V2
Failed to start application '/LM/W3SVC/6/ROOT/', ErrorCode '0x800700c1'.
```

Не удалось запустить приложение, так как не удалось загрузить сборку приложения ( *.dll*).

Эта ошибка возникает, если существует несоответствие разрядности опубликованного приложения и процесса w3wp/iisexpress.

Убедитесь, что параметр 32-разрядности пула приложений указан правильно:

1. Выберите пул приложений в диспетчере служб IIS в разделе **Пулы приложений**.
1. Выберите **Дополнительные параметры** в разделе **Изменение пула приложений** панели **Действия**.
1. Установите параметр **Включить 32-разрядные приложения**:
   * При развертывании 32-разрядного (x86) приложения задайте значение `True`.
   * При развертывании 64-разрядного (x64) приложения задайте значение `False`.

### <a name="connection-reset"></a>Сброс подключения

Если ошибка возникает после отправки заголовков, сервер уже не может отправить страницу **500 — внутренняя ошибка сервера**. Это часто происходит, когда ошибка возникает во время сериализации составных объектов ответа. Этот тип ошибки отображается на стороне клиента как ошибка *Сброс подключения*. [Ведение журналов для приложений](xref:fundamentals/logging/index) может помочь устранить эти ошибки.

### <a name="default-startup-limits"></a>Ограничения по умолчанию при запуске

Для [модуля ASP.NET Core](xref:host-and-deploy/aspnet-core-module) настроено значение по умолчанию *startupTimeLimit* , равное 120 секундам. Если оставить значение по умолчанию, то прежде чем журнал модуля зарегистрирует ошибку запуска приложения, может пройти до двух минут. Сведения о настройке модуля см. в разделе [Атрибуты элемента aspNetCore](xref:host-and-deploy/aspnet-core-module#attributes-of-the-aspnetcore-element).

## <a name="troubleshoot-on-azure-app-service"></a>Устранение неполадок в службе приложений Azure

[!INCLUDE [Azure App Service Preview Notice](~/includes/azure-apps-preview-notice.md)]

### <a name="application-event-log-azure-app-service"></a>Журнал событий приложений (служба приложений Azure)

Чтобы получить доступ к журналу событий приложения, используйте колонку **Диагностика и решение проблем** на портале Azure.

1. На портале Azure откройте приложение в колонке **Службы приложений**.
1. Выберите колонку **Диагностика и решение проблем**.
1. Щелкните заголовок **Средства диагностики**.
1. В разделе **Средства поддержки** нажмите кнопку **События приложений**.
1. Изучите последние ошибки из журнала *IIS AspNetCoreModule* или *IIS AspNetCoreModule V2* в столбце **Источник**.

Вместо использования колонки **Диагностика и решение проблем** можно изучить файл журнала событий приложения непосредственно с помощью консоли [Kudu](https://github.com/projectkudu/kudu/wiki).

1. В области **Средства разработки** откройте колонку **Дополнительные инструменты**. Нажмите кнопку **Перейти&rarr;** . Консоль Kudu открывается в новой вкладке или в окне браузера.
1. С помощью панели навигации в верхней части страницы откройте **Консоль отладки** и выберите **CMD**.
1. Откройте папку **LogFiles**.
1. Выберите значок с карандашом рядом с файлом *eventlog.xml*.
1. Изучите журнал. Прокрутите список до нижней части журнала, чтобы просмотреть последние события.

### <a name="run-the-app-in-the-kudu-console"></a>Запуск приложения в консоли Kudu

Многие ошибки запуска не создают полезные сведения в журнале событий приложения. Чтобы обнаружить ошибку, можно запустить приложение в удаленной консоли выполнения [Kudu](https://github.com/projectkudu/kudu/wiki).

1. В области **Средства разработки** откройте колонку **Дополнительные инструменты**. Нажмите кнопку **Перейти&rarr;** . Консоль Kudu открывается в новой вкладке или в окне браузера.
1. С помощью панели навигации в верхней части страницы откройте **Консоль отладки** и выберите **CMD**.

#### <a name="test-a-32-bit-x86-app"></a>Тестирование 32-разрядного (x86) приложения

**Текущий выпуск**

1. `cd d:\home\site\wwwroot`
1. Запустите приложение:
   * Если развертываемое приложение [зависит от платформы](/dotnet/core/deploying/#framework-dependent-deployments-fdd), сделайте следующее:

     ```console
     dotnet .\{ASSEMBLY NAME}.dll
     ```

   * Если приложение [развертывается автономно](/dotnet/core/deploying/#self-contained-deployments-scd), сделайте следующее:

     ```console
     {ASSEMBLY NAME}.exe
     ```

Выходные данные из приложения, отображающие любые ошибки, будут выведены на консоль Kudu.

**Развертывание, зависимое от платформы, выполняющееся в предварительной версии**

*Требует установки расширения сайта для среды выполнения ASP.NET Core {VERSION} (x86).*

1. `cd D:\home\SiteExtensions\AspNetCoreRuntime.{X.Y}.x32` (`{X.Y}` — это версия среды выполнения).
1. Запустите приложение: `dotnet \home\site\wwwroot\{ASSEMBLY NAME}.dll`.

Выходные данные из приложения, отображающие любые ошибки, будут выведены на консоль Kudu.

#### <a name="test-a-64-bit-x64-app"></a>Тестирование 64-разрядного (x64) приложения

**Текущий выпуск**

* Если приложение является 64-разрядным (x64) [зависимым от платформы развертыванием](/dotnet/core/deploying/#framework-dependent-deployments-fdd):
  1. `cd D:\Program Files\dotnet`
  1. Запустите приложение: `dotnet \home\site\wwwroot\{ASSEMBLY NAME}.dll`.
* Если приложение [развертывается автономно](/dotnet/core/deploying/#self-contained-deployments-scd), сделайте следующее:
  1. `cd D:\home\site\wwwroot`
  1. Запустите приложение: `{ASSEMBLY NAME}.exe`.

Выходные данные из приложения, отображающие любые ошибки, будут выведены на консоль Kudu.

**Развертывание, зависимое от платформы, выполняющееся в предварительной версии**

*Требует установки расширения сайта для среды выполнения ASP.NET Core {VERSION} (x64).*

1. `cd D:\home\SiteExtensions\AspNetCoreRuntime.{X.Y}.x64` (`{X.Y}` — это версия среды выполнения).
1. Запустите приложение: `dotnet \home\site\wwwroot\{ASSEMBLY NAME}.dll`.

Выходные данные из приложения, отображающие любые ошибки, будут выведены на консоль Kudu.

### <a name="aspnet-core-module-stdout-log-azure-app-service"></a>Журнал ASP.NET Core модуля stdout (служба приложений Azure)

В журнале stdout модуля ASP.NET Core часто записываются полезные сообщения, которые не удается найти в журнале событий приложения. Чтобы включить и просмотреть журналы stdout выполните следующие действия.

1. Перейдите к колонке **Диагностика и решение проблем** на портале Azure.
1. В разделе **Выберите категорию проблемы** нажмите кнопку **Веб-приложение не работает**.
1. В разделе **Предлагаемые решения** > **Включить перенаправление журнала stdout** нажмите кнопку **Открыть консоль Kudu для редактирования файла Web.Config**.
1. В **консоли диагностики** Kudu откройте папки на пути **веб-сайт** > **wwwroot**. Прокрутите список вниз, чтобы в его нижней части показался файл *web.config*.
1. Щелкните значок карандаша рядом с файлом *web.config*.
1. Установите для параметра **stdoutLogEnabled** значение `true` и измените путь **stdoutLogFile** на `\\?\%home%\LogFiles\stdout`.
1. Выберите **Сохранить** для сохранения обновленного файла *web.config*.
1. Сделайте запрос к приложению.
1. Вернитесь на портал Azure. Выберите колонку **Дополнительные инструменты** в области **Средства разработки**. Нажмите кнопку **Перейти&rarr;** . Консоль Kudu открывается в новой вкладке или в окне браузера.
1. С помощью панели навигации в верхней части страницы откройте **Консоль отладки** и выберите **CMD**.
1. Выберите папку **LogFiles**.
1. Изучите столбец **Изменено** и выберите значок карандаша, чтобы отредактировать журнал stdout для последней даты изменения.
1. При открытии файла журнала отображается сообщение об ошибке.

Завершив устранение неполадок, отключите ведение журнала stdout.

1. В **консоли диагностики** Kudu вернитесь к пути **веб-сайт** > **wwwroot**, чтобы открыть файл *web.config*. Выбрав значок карандаша, снова откройте файл **web.config**.
1. Задайте параметру **stdoutLogEnabled** значение `false`.
1. Нажмите кнопку **Сохранить** для сохранения файла.

Дополнительные сведения см. в разделе <xref:host-and-deploy/aspnet-core-module#log-creation-and-redirection>.

> [!WARNING]
> Ошибка при отключении журнала stdout может привести к сбоям приложения или сервера. Ни размер файла журнала, ни количество создаваемых файлов журналов ничем не ограничены. Для устранения неполадок при запуске приложения используйте только журнал stdout.
>
> После запуска в приложении ASP.NET Core для ведения общего журнала используйте библиотеку ведения журналов, которая ограничивает размер файла журнала и выполняет циклический сдвиг журналов. Дополнительные сведения см. в разделе [Сторонние поставщики ведения журналов](xref:fundamentals/logging/index#third-party-logging-providers).

::: moniker range=">= aspnetcore-2.2"

### <a name="aspnet-core-module-debug-log-azure-app-service"></a>Журнал отладки модуля ASP.NET Core (служба приложений Azure)

В журнал отладки модуля ASP.NET записываются дополнительные и более подробные сообщения, относящиеся к модулю ASP.NET Core. Чтобы включить и просмотреть журналы stdout, сделайте следующее:

1. Чтобы включить ведение расширенного журнала диагностики, выполните одно из следующих действий.
   * Следуйте инструкциям по настройке приложения для ведения расширенных журналов диагностики, приведенным в разделе [Расширенные журналы диагностики](xref:host-and-deploy/aspnet-core-module#enhanced-diagnostic-logs). Повторно разверните приложение.
   * С помощью консоли Kudu добавьте раздел `<handlerSettings>` в файл *web.config* приложения, как показано в разделе [Расширенные журналы диагностики](xref:host-and-deploy/aspnet-core-module#enhanced-diagnostic-logs).
     1. В области **Средства разработки** откройте колонку **Дополнительные инструменты**. Нажмите кнопку **Перейти&rarr;** . Консоль Kudu открывается в новой вкладке или в окне браузера.
     1. С помощью панели навигации в верхней части страницы откройте **Консоль отладки** и выберите **CMD**.
     1. Откройте папки на пути **веб-сайт** > **wwwroot**. Нажмите кнопку с изображением карандаша и внесите изменения в файл *web.config*. Добавьте раздел `<handlerSettings>`, как описано в разделе [Расширенные журналы диагностики](xref:host-and-deploy/aspnet-core-module#enhanced-diagnostic-logs). Нажмите кнопку **Сохранить**.
1. В области **Средства разработки** откройте колонку **Дополнительные инструменты**. Нажмите кнопку **Перейти&rarr;** . Консоль Kudu открывается в новой вкладке или в окне браузера.
1. С помощью панели навигации в верхней части страницы откройте **Консоль отладки** и выберите **CMD**.
1. Откройте папки на пути **веб-сайт** > **wwwroot**. Если вы не указали путь к файлу *aspnetcore-debug.log*, файл появится в списке. Если путь указан, перейдите к расположению файла журнала.
1. Откройте файл журнала, нажав кнопку с изображением карандаша рядом с именем файла.

Завершив устранение неполадок, отключите ведение журнала отладки.

Чтобы отключить ведение расширенных журналов отладки, выполните одно из следующих действий:

* Удалите раздел `<handlerSettings>` из файла *web.config* локально и повторно разверните приложение.
* С помощью консоли Kudu внесите изменения в файл *web.config* и удалите раздел `<handlerSettings>`. Сохраните файл.

Дополнительные сведения см. в разделе <xref:host-and-deploy/aspnet-core-module#enhanced-diagnostic-logs>.

> [!WARNING]
> Ошибка при отключении журнала отладки может привести к сбоям приложения или сервера. Ограничения на размер файла журнала отсутствуют. Для устранения неполадок при запуске приложения используйте только журнал отладки.
>
> После запуска в приложении ASP.NET Core для ведения общего журнала используйте библиотеку ведения журналов, которая ограничивает размер файла журнала и выполняет циклический сдвиг журналов. Дополнительные сведения см. в разделе [Сторонние поставщики ведения журналов](xref:fundamentals/logging/index#third-party-logging-providers).

::: moniker-end

### <a name="slow-or-hanging-app-azure-app-service"></a>Приложение с задержкой или зависанием (служба приложений Azure)

Если приложение медленно реагирует на запрос или зависает при его обработке, см. следующие статьи:

* [Устранение проблем с производительностью медленных веб приложений в службе приложений Azure](/azure/app-service/app-service-web-troubleshoot-performance-degradation)
* [Use Crash Diagnoser Site Extension to Capture Dump for Intermittent Exception issues or performance issues on Azure Web App (Использование расширения сайта средства диагностики сбоев для записи дампа при периодических проблемах с исключением или проблемах с производительностью в веб-приложении Azure)](https://blogs.msdn.microsoft.com/asiatech/2015/12/28/use-crash-diagnoser-site-extension-to-capture-dump-for-intermittent-exception-issues-or-performance-issues-on-azure-web-app/).

### <a name="monitoring-blades"></a>Мониторинг колонок

Мониторинг колонок обеспечивает альтернативный поиск неисправностей методам, описанным ранее в этом разделе. Эти колонки можно использовать для диагностики ошибок 500-й серии.

Убедитесь, что установлены расширения ASP.NET Core. Если расширения не установлены, установите их вручную, выполнив следующие действия.

1. В колонке **Средства разработки** выберите колонку **Расширения**.
1. В списке должны появиться **Расширения ASP.NET Core**.
1. Если расширения не установлены, нажмите кнопку **Добавить**.
1. Выберите из списка **Расширения ASP.NET Core**.
1. Для принятия условий нажмите кнопку **ОК**.
1. Нажмите кнопку **ОК** в колонке **Добавить расширение**.
1. Информационное всплывающее сообщение указывает, когда расширения успешно установятся.

Если ведение журнала stdout не включено, выполните следующие действия.

1. На портале Azure выберите колонку **Дополнительные инструменты** в области **Средства разработки**. Нажмите кнопку **Перейти&rarr;** . Консоль Kudu открывается в новой вкладке или в окне браузера.
1. С помощью панели навигации в верхней части страницы откройте **Консоль отладки** и выберите **CMD**.
1. Откройте папки на пути **веб-сайт** > **wwwroot** и прокрутите список вниз, пока в нижней части не покажется файл *web.config*.
1. Щелкните значок карандаша рядом с файлом *web.config*.
1. Установите для параметра **stdoutLogEnabled** значение `true` и измените путь **stdoutLogFile** на `\\?\%home%\LogFiles\stdout`.
1. Выберите **Сохранить** для сохранения обновленного файла *web.config*.

Перейдите к активации ведения журнала диагностики, выполнив следующие действия.

1. На портале Azure выберите колонку **Журналы диагностики**.
1. Выберите положение переключателя **Вкл.** для **Вход в приложения (файловая система)** и **Подробные сообщения об ошибках**. В верхней части колонки нажмите кнопку **Сохранить**.
1. Чтобы включить трассировку неудачно завершенных запросов, также известную как ведение журнала буферизации событий неудачных запросов (FREB), установите положение переключателя **Вкл.** для **Трассировки неудачно завершенных запросов**.
1. На портале выберите колонку **Поток журнала**, которая в списке отображается сразу под колонкой **Журналы диагностики**.
1. Сделайте запрос к приложению.
1. В пределах данных потока журнала указывается причина ошибки.

После завершения устранения неполадок обязательно отключите ведение журнала stdout.

Чтобы просмотреть журналы трассировки неудачно завершенных запросов (журналы FREB), выполните следующие действия.

1. Перейдите к колонке **Диагностика и решение проблем** на портале Azure.
1. Выберите **Журналы трассировки неудачно завершенных запросов** из области боковой панели **Средства поддержки**.

Для получения дополнительной информации см. [Раздел "Трассировка неудачно завершенных запросов" раздела "Включение ведения журналов диагностики для веб-приложений в службе приложений Azure"](/azure/app-service/web-sites-enable-diagnostic-log#failed-request-traces) и ["Вопросы и ответы о производительности приложений для веб-приложений в Azure: как включить трассировку неудачно завершенных запросов?"](/azure/app-service/app-service-web-availability-performance-application-issues-faq#how-do-i-turn-on-failed-request-tracing)

Дополнительные сведения см. в разделе [Включение функции ведения журналов диагностики для веб-приложений в службе приложений Azure](/azure/app-service/web-sites-enable-diagnostic-log).

> [!WARNING]
> Ошибка при отключении журнала stdout может привести к сбоям приложения или сервера. Ни размер файла журнала, ни количество создаваемых файлов журналов ничем не ограничены.
>
> Для обычного ведения журналов для приложения ASP.NET Core используйте библиотеку, которая ограничивает размер файла журнала и выполняет циклический сдвиг журналов. Дополнительные сведения см. в разделе [Сторонние поставщики ведения журналов](xref:fundamentals/logging/index#third-party-logging-providers).

## <a name="troubleshoot-on-iis"></a>Устранение неполадок в службах IIS

### <a name="application-event-log-iis"></a>Журнал событий приложений (IIS)

Доступ к журналу событий приложений

1. Откройте меню "Пуск", выполните поиск по фразе **Просмотр событий** и выберите приложение **Просмотр событий**.
1. В **средстве просмотра событий** откройте узел **Журналы Windows**.
1. Выберите **Приложение**, чтобы открыть журнал событий приложения.
1. Проверьте здесь наличие ошибок, связанных с проблемным приложением. Нам нужны ошибки со значениями *Модуль IIS AspNetCore* или *Модуль IIS Express AspNetCore* в столбце *Источник*.

### <a name="run-the-app-at-a-command-prompt"></a>Запуск приложения в командной строке

Многие ошибки запуска не создают полезные сведения в журнале событий приложения. Для некоторых ошибок можно найти причину, запустив приложение в командной строке на компьютере размещения.

#### <a name="framework-dependent-deployment"></a>развертывание, зависящее от платформы;

Если развертываемое приложение [зависит от платформы](/dotnet/core/deploying/#framework-dependent-deployments-fdd), сделайте следующее:

1. В командной строке перейдите в папку развертывания и запустите приложение, выполнив команду *dotnet.exe* для сборки приложения. В следующей команде укажите нужное имя сборки вместо заполнителя \<assembly_name>: `dotnet .\<assembly_name>.dll`.
1. Выходные данные приложения, в том числе любые ошибки, будут выведены в окно консоли.
1. Если ошибки возникают при выполнении запроса к приложению, выполните запрос к узлу и порту, где Kestrel ожидает передачи данных. Создайте запрос к `http://localhost:5000/`, используя узел и порт по умолчанию. Если приложение отвечает на запросы по адресу конечной точки Kestrel как обычно, то проблема, вероятнее, связана с конфигурацией размещения, а не с самим приложением.

#### <a name="self-contained-deployment"></a>автономное развертывание;

Если приложение [развертывается автономно](/dotnet/core/deploying/#self-contained-deployments-scd), сделайте следующее:

1. В командной строке перейдите в папку развертывания и запустите исполняемый файл приложения. В следующей команде укажите нужное имя сборки вместо заполнителя \<assembly_name>: `<assembly_name>.exe`.
1. Выходные данные приложения, в том числе любые ошибки, будут выведены в окно консоли.
1. Если ошибки возникают при выполнении запроса к приложению, выполните запрос к узлу и порту, где Kestrel ожидает передачи данных. Создайте запрос к `http://localhost:5000/`, используя узел и порт по умолчанию. Если приложение отвечает на запросы по адресу конечной точки Kestrel как обычно, то проблема, вероятнее, связана с конфигурацией размещения, а не с самим приложением.

### <a name="aspnet-core-module-stdout-log-iis"></a>Журнал stdout модуля ASP.NET Core (IIS)

Чтобы включить и просмотреть журналы stdout, сделайте следующее:

1. Перейдите в папку развертывания сайта на компьютере размещения.
1. Если здесь нет папки *logs*, создайте ее. Сведения о том, как настроить в MSBuild автоматическое создание папки *logs* в развертывании, см. в статье [о структуре каталогов](xref:host-and-deploy/directory-structure).
1. Измените файл *web.config*. Задайте для параметра **stdoutLogEnabled** значение `true` и измените путь **stdoutLogFile** так, чтобы он указывал на папку *logs* (например, `.\logs\stdout`). В этом пути `stdout` обозначает префикс имени для файла журнала. При создании файла журнала автоматически добавляются метка времени, идентификатор процесса и расширение файла. Если указан префикс файла `stdout`, стандартный файл журнала будет иметь примерно такое имя: *stdout_20180205184032_5412.log*.
1. Убедитесь, что удостоверение пула приложений имеет разрешения на запись в папку *logs*.
1. Сохраните обновленный файл *web.config*.
1. Сделайте запрос к приложению.
1. Перейдите в папку *logs*. Найдите и откройте последний журнал вывода stdout.
1. Проверьте, нет ли в нем ошибок.

Завершив устранение неполадок, отключите ведение журнала stdout.

1. Измените файл *web.config*.
1. Задайте параметру **stdoutLogEnabled** значение `false`.
1. Сохраните файл.

Дополнительные сведения см. в разделе <xref:host-and-deploy/aspnet-core-module#log-creation-and-redirection>.

> [!WARNING]
> Ошибка при отключении журнала stdout может привести к сбоям приложения или сервера. Ни размер файла журнала, ни количество создаваемых файлов журналов ничем не ограничены.
>
> Для обычного ведения журналов для приложения ASP.NET Core используйте библиотеку, которая ограничивает размер файла журнала и выполняет циклический сдвиг журналов. Дополнительные сведения см. в разделе [Сторонние поставщики ведения журналов](xref:fundamentals/logging/index#third-party-logging-providers).

::: moniker range=">= aspnetcore-2.2"

### <a name="aspnet-core-module-debug-log-iis"></a>Журнал отладки модуля ASP.NET Core (IIS)

Добавьте следующие параметры обработчика в файл *Web. config* приложения, чтобы включить ASP.NET Core журнал отладки модуля:

```xml
<aspNetCore ...>
  <handlerSettings>
    <handlerSetting name="debugLevel" value="file" />
    <handlerSetting name="debugFile" value="c:\temp\ancm.log" />
  </handlerSettings>
</aspNetCore>
```

Убедитесь, что указанный для журнала путь существует и удостоверение пула приложений имеет разрешения на запись в это расположение.

Дополнительные сведения см. в разделе <xref:host-and-deploy/aspnet-core-module#enhanced-diagnostic-logs>.

::: moniker-end

### <a name="enable-the-developer-exception-page"></a>Включение страницы исключений для разработчика

Можно добавить переменную среды `ASPNETCORE_ENVIRONMENT` [в файл web.config](xref:host-and-deploy/aspnet-core-module#setting-environment-variables), чтобы запустить приложение в среде разработки. Если среда не переопределяется при запуске приложения использованием `UseEnvironment` в конструкторе узла, эта переменная среды позволяет отображать [страницу исключения для разработчика](xref:fundamentals/error-handling) при запуске приложения.

::: moniker range=">= aspnetcore-2.2"

```xml
<aspNetCore processPath="dotnet"
      arguments=".\MyApp.dll"
      stdoutLogEnabled="false"
      stdoutLogFile=".\logs\stdout"
      hostingModel="InProcess">
  <environmentVariables>
    <environmentVariable name="ASPNETCORE_ENVIRONMENT" value="Development" />
  </environmentVariables>
</aspNetCore>
```

::: moniker-end

::: moniker range="< aspnetcore-2.2"

```xml
<aspNetCore processPath="dotnet"
      arguments=".\MyApp.dll"
      stdoutLogEnabled="false"
      stdoutLogFile=".\logs\stdout">
  <environmentVariables>
    <environmentVariable name="ASPNETCORE_ENVIRONMENT" value="Development" />
  </environmentVariables>
</aspNetCore>
```

::: moniker-end

Настройка переменной среды `ASPNETCORE_ENVIRONMENT` рекомендуется только на промежуточных и тестовых серверах, доступ к которым из Интернета закрыт. Завершив устранение неполадок, удалите эту переменную среды из файла *web.config*. Сведения о настройке переменных среды в файле *web.config* см. в статье о [дочернем элементе environmentVariables в aspNetCore](xref:host-and-deploy/aspnet-core-module#setting-environment-variables).

### <a name="obtain-data-from-an-app"></a>Получение данных из приложения

Если приложение способно отвечать на запросы, получите данные о запросе, подключении и дополнительные данные из приложений с помощью встроенного терминала ПО промежуточного слоя. Дополнительные сведения и примеры с кодом см. здесь: <xref:test/troubleshoot#obtain-data-from-an-app>.

### <a name="slow-or-hanging-app-iis"></a>Низкое или зависание приложения (IIS)

*Аварийный дамп* — это моментальный снимок памяти системы, который может помочь определить причину сбоя приложения, сбоя при запуске или медленных приложений.

#### <a name="app-crashes-or-encounters-an-exception"></a>Аварийное завершение работы приложения или исключение

Получите и проанализируйте дамп из [отчетов об ошибках Windows (WER)](/windows/desktop/wer/windows-error-reporting):

1. Создайте папку для хранения файлов аварийного дампа в `c:\dumps`. Пул приложений должен иметь доступ на запись к папке.
1. Запустите [скрипт PowerShell EnableDumps](https://github.com/aspnet/AspNetCore.Docs/blob/master/aspnetcore/test/troubleshoot-azure-iis/scripts/EnableDumps.ps1):
   * Если приложение использует [модель размещения в процессе](xref:host-and-deploy/iis/index#in-process-hosting-model), выполните скрипт для *w3wp.exe*:

     ```console
     .\EnableDumps w3wp.exe c:\dumps
     ```

   * Если приложение использует [модель размещения вне процесса](xref:host-and-deploy/iis/index#out-of-process-hosting-model), выполните скрипт для *dotnet.exe*:

     ```console
     .\EnableDumps dotnet.exe c:\dumps
     ```

1. Запустите приложение в условиях, вызывающих аварийное завершение.
1. После аварийного завершения запустите [скрипт PowerShell DisableDumps](https://github.com/aspnet/AspNetCore.Docs/blob/master/aspnetcore/test/troubleshoot-azure-iis/scripts/DisableDumps.ps1):
   * Если приложение использует [модель размещения в процессе](xref:host-and-deploy/iis/index#in-process-hosting-model), выполните скрипт для *w3wp.exe*:

     ```console
     .\DisableDumps w3wp.exe
     ```

   * Если приложение использует [модель размещения вне процесса](xref:host-and-deploy/iis/index#out-of-process-hosting-model), выполните скрипт для *dotnet.exe*:

     ```console
     .\DisableDumps dotnet.exe
     ```

Когда приложение аварийно завершит работу и сбор дампов будет выполнен, приложение сможет завершить работу обычным образом. Скрипт PowerShell настраивает отчеты об ошибках Windows для сбора до пяти дампов для приложения.

> [!WARNING]
> Аварийные дампы могут занимать много места на диске (до нескольких гигабайтов каждый).

#### <a name="app-hangs-fails-during-startup-or-runs-normally"></a>Приложение перестает отвечать на запросы, не запускается или работает в обычном режиме

Когда приложение *перестает отвечать на запросы* (но аварийное завершение не происходит), не запускается или работает в обычном режиме, см. раздел [Файлы дампа пользовательского режима: выбор лучшего инструмента](/windows-hardware/drivers/debugger/user-mode-dump-files#choosing-the-best-tool), чтобы выбрать подходящий инструмент для создания дампа.

#### <a name="analyze-the-dump"></a>Анализ дампа

Дамп можно проанализировать несколькими способами. Дополнительные сведения см. в разделе [Анализ файла дампа пользовательского режима](/windows-hardware/drivers/debugger/analyzing-a-user-mode-dump-file).

## <a name="clear-package-caches"></a>Очистить кэши пакетов

Иногда работающее приложение завершается сбоем сразу после обновления пакет SDK для .NET Core на компьютере разработки или при изменении версий пакета в приложении. В некоторых случаях в результате важного обновления несогласованные версии пакетов могут привести к нарушению работы приложения. Большинство этих проблем можно исправить следующим образом:

1. Удалите папки *bin* и *obj*.
1. Очистите кэши пакетов, выполнив `dotnet nuget locals all --clear` команду из командной оболочки.

   Очистка кэшей пакетов также может быть выполнена с помощью средства [NuGet. exe](https://www.nuget.org/downloads) и выполнения команды `nuget locals all -clear`. *NuGet.exe* не входит в пакет установки операционной системы Windows для настольных компьютеров и его нужно получить отдельно на [веб-сайте NuGet](https://www.nuget.org/downloads).

1. Восстановите и перестройте проект.
1. Удалите все файлы из папки развертывания на сервере перед повторным развертыванием приложения.

## <a name="additional-resources"></a>Дополнительные ресурсы

* <xref:test/troubleshoot>
* <xref:host-and-deploy/azure-iis-errors-reference>
* <xref:fundamentals/error-handling>
* <xref:host-and-deploy/aspnet-core-module>

### <a name="azure-documentation"></a>Документация по Azure

* [Application Insights для ASP.NET Core](/azure/application-insights/app-insights-asp-net-core)
* [Раздел "Удаленная отладка веб-приложений" статьи Устранение неполадок веб-приложения в службе приложений Azure с помощью Visual Studio](/azure/app-service/web-sites-dotnet-troubleshoot-visual-studio#remotedebug)
* [Общие сведения о диагностике в службе приложений Azure](/azure/app-service/app-service-diagnostics)
* [Практическое руководство. Мониторинг приложений в Службе приложений Azure](/azure/app-service/web-sites-monitor)
* [Устранение неполадок веб-приложения в службе приложений Azure с помощью Visual Studio](/azure/app-service/web-sites-dotnet-troubleshoot-visual-studio)
* [Устранение ошибок HTTP "502 — недопустимый шлюз" и "503 — служба недоступна" в веб-приложениях Azure](/azure/app-service/app-service-web-troubleshoot-http-502-http-503)
* [Устранение проблем с производительностью медленных веб приложений в службе приложений Azure](/azure/app-service/app-service-web-troubleshoot-performance-degradation)
* [Вопросы и ответы о производительности приложений для веб-приложений в Azure](/azure/app-service/app-service-web-availability-performance-application-issues-faq)
* ["Песочница" веб-приложений Azure (ограничения работы среды выполнения службы приложений)](https://github.com/projectkudu/kudu/wiki/Azure-Web-App-sandbox)
* [Пятница с Azure. Практика диагностики и устранения неполадок в Службе приложений Azure (12-минутное видео)](https://channel9.msdn.com/Shows/Azure-Friday/Azure-App-Service-Diagnostic-and-Troubleshooting-Experience)

### <a name="visual-studio-documentation"></a>Документация по Visual Studio

* [Удаленная отладка ASP.NET Core на IIS в Azure в Visual Studio 2017](/visualstudio/debugger/remote-debugging-azure)
* [Удаленная отладка ASP.NET Core на удаленном компьютере IIS в Visual Studio 2017](/visualstudio/debugger/remote-debugging-aspnet-on-a-remote-iis-computer)
* [Сведения об отладке с помощью Visual Studio](/visualstudio/debugger/getting-started-with-the-debugger)

### <a name="visual-studio-code-documentation"></a>Документация по Visual Studio Code

* [Отладка с помощью Visual Studio Code](https://code.visualstudio.com/docs/editor/debugging)
